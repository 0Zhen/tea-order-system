<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßã Â∞èÊæÑÂ∏Ç</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 40px;
            text-align: center;
        }
        
        .login-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
        }
        
        .error-message {
            color: #dc3545;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .status-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-connected {
            background: #28a745;
            color: white;
        }
        
        .status-disconnected {
            background: #dc3545;
            color: white;
        }
        
        .status-loading {
            background: #ffc107;
            color: #333;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .options-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .option-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .option-section label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .toppings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 5px;
        }
        
        .topping-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        
        .topping-item input[type="checkbox"] {
            margin: 0;
        }
        
        .control-group label {
            font-weight: bold;
            min-width: 80px;
        }
        
        select, input, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        select {
            min-width: 200px;
        }
        
        input[type="number"] {
            width: 80px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .admin-controls {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .admin-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2d5a2d;
        }
        
        .table-container {
            overflow-x: auto;
            padding: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        tr:hover {
            background: #e9ecef;
        }
        
        .total-row {
            background: #e3f2fd !important;
            font-weight: bold;
        }
        
        .summary {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .summary h3 {
            margin: 0 0 10px 0;
            color: #2d5a2d;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        @media (max-width: 768px) {
            .login-container {
                margin: 20px auto;
                padding: 30px 20px;
            }
            
            .container {
                margin: 10px;
                border-radius: 0;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group label {
                min-width: auto;
            }
            
            select, input {
                min-width: auto;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- ÁôªÂÖ•È†ÅÈù¢ -->
    <div id="loginPage" class="login-container">
        <div class="login-title">üßã Â∞èÊæÑÂ∏Ç</div>
        <div class="login-subtitle">Ë´ãËº∏ÂÖ•ÂØÜÁ¢º‰ª•ÁπºÁ∫å</div>
        <input type="password" id="passwordInput" class="password-input" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" />
        <button id="loginBtn" class="login-btn">ÁôªÂÖ•</button>
        <div id="loginError" class="error-message" style="display: none;"></div>
    </div>

    <!-- ‰∏ªË¶ÅÁ≥ªÁµ±È†ÅÈù¢ -->
    <div id="mainPage" class="container">
        <div class="header">
            <h1>üßã Â∞èÊæÑÂ∏Ç</h1>
            <p>Âç≥ÊôÇÂêåÊ≠•ÔºåÂ§ö‰∫∫Âçî‰ΩúÈªûÈ§ê</p>
            <button id="logoutBtn" class="logout-btn">ÁôªÂá∫</button>
            <div id="statusIndicator" class="status-indicator status-loading">ÈÄ£Êé•‰∏≠...</div>
        </div>
        
        <!-- ÁÆ°ÁêÜËÄÖÊéßÂà∂Èù¢Êùø -->
        <div class="admin-controls">
            <div class="admin-title">üìä ÁÆ°ÁêÜËÄÖÊéßÂà∂Èù¢Êùø</div>
            <div class="control-group">
                <button id="exportBtn" class="btn-success">ÂåØÂá∫ÊâÄÊúâË®ÇÂñÆ CSV</button>
                <button id="clearBtn" class="btn-danger">Ê∏ÖÁ©∫ÊâÄÊúâË®ÇÂñÆ</button>
                <span style="margin-left: 20px; font-weight: bold;">Âç≥ÊôÇÊõ¥Êñ∞Ôºö<span id="lastUpdate">-</span></span>
            </div>
        </div>
        
        <!-- ÈªûÈ§êË°®ÂñÆ -->
        <div class="controls">
            <div class="control-group">
                <label>ÈÅ∏ÊìáÂàÜÈ°ûÔºö</label>
                <select id="categorySelect">
                    <option value="">Ë´ãÈÅ∏ÊìáÂàÜÈ°û</option>
                    <option value="ÂéüËêÉÂ∞èËå∂È§®">ÂéüËêÉÂ∞èËå∂È§®</option>
                    <option value="ÈÄ†Â∏ÇÂ∞èÁßòÂ¢É">ÈÄ†Â∏ÇÂ∞èÁßòÂ¢É</option>
                    <option value="ÈÆÆÊ¶®Â∞èÊ∏ÖÁø†">ÈÆÆÊ¶®Â∞èÊ∏ÖÁø†</option>
                    <option value="ÈÜáÈüªÂ•∂Ëå∂">ÈÜáÈüªÂ•∂Ëå∂</option>
                    <option value="ÈÇÄËå∂Â∏Ç">ÈÇÄËå∂Â∏Ç</option>
                    <option value="ÁæéÂ¶ôÈôêÂÆö">ÁæéÂ¶ôÈôêÂÆö</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>ÈÅ∏ÊìáÂìÅÈ†ÖÔºö</label>
                <select id="itemSelect" disabled>
                    <option value="">Ë´ãÂÖàÈÅ∏ÊìáÂàÜÈ°û</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>È°ßÂÆ¢ÂßìÂêçÔºö</label>
                <input type="text" id="customerName" placeholder="Ë´ãËº∏ÂÖ•È°ßÂÆ¢ÂßìÂêç" disabled style="min-width: 150px;">
            </div>
            
            <div class="options-group" id="optionsGroup" style="display: none;">
                <div class="option-section">
                    <label>ÁîúÂ∫¶Ôºö</label>
                    <select id="sweetnessSelect">
                        <option value="Ê≠£Â∏∏Áîú">Ê≠£Â∏∏Áîú</option>
                        <option value="Â∞ëÁ≥ñ">Â∞ëÁ≥ñ</option>
                        <option value="ÂçäÁ≥ñ">ÂçäÁ≥ñ</option>
                        <option value="ÂæÆÁ≥ñ">ÂæÆÁ≥ñ</option>
                        <option value="1ÂàÜÁ≥ñ">1ÂàÜÁ≥ñ</option>
                        <option value="ÁÑ°Á≥ñ">ÁÑ°Á≥ñ</option>
                    </select>
                </div>
                
                <div class="option-section">
                    <label>ÂÜ∞Â°äÔºö</label>
                    <select id="iceSelect">
                        <option value="Ê≠£Â∏∏ÂÜ∞">Ê≠£Â∏∏ÂÜ∞</option>
                        <option value="Â∞ëÂÜ∞">Â∞ëÂÜ∞</option>
                        <option value="ÂæÆÂÜ∞">ÂæÆÂÜ∞</option>
                        <option value="ÂéªÂÜ∞">ÂéªÂÜ∞</option>
                        <option value="Ê∫´È£≤">Ê∫´È£≤</option>
                        <option value="ÁÜ±È£≤">ÁÜ±È£≤</option>
                    </select>
                </div>
                
                <div class="option-section">
                    <label>Âä†ÊñôÔºö</label>
                    <div class="toppings-grid">
                        <div class="topping-item">
                            <input type="checkbox" id="topping1" value="ÁèçÁè†" data-price="10">
                            <label for="topping1">ÁèçÁè† (+$10)</label>
                        </div>
                        <div class="topping-item">
                            <input type="checkbox" id="topping2" value="Ê§∞Êûú" data-price="10">
                            <label for="topping2">Ê§∞Êûú (+$10)</label>
                        </div>
                        <div class="topping-item">
                            <input type="checkbox" id="topping3" value="Â∏É‰∏Å" data-price="15">
                            <label for="topping3">Â∏É‰∏Å (+$15)</label>
                        </div>
                        <div class="topping-item">
                            <input type="checkbox" id="topping4" value="‰ªôËçâ" data-price="10">
                            <label for="topping4">‰ªôËçâ (+$10)</label>
                        </div>
                        <div class="topping-item">
                            <input type="checkbox" id="topping5" value="ÊÑõÁéâ" data-price="15">
                            <label for="topping5">ÊÑõÁéâ (+$15)</label>
                        </div>
                        <div class="topping-item">
                            <input type="checkbox" id="topping6" value="ËòÜËñà" data-price="10">
                            <label for="topping6">ËòÜËñà (+$10)</label>
                        </div>
                        <div class="topping-item">
                            <input type="checkbox" id="topping7" value="Â•∂Ëìã" data-price="20">
                            <label for="topping7">Â•∂Ëìã (+$20)</label>
                        </div>
                        <div class="topping-item">
                            <input type="checkbox" id="topping8" value="ÈÆÆÂ•∂" data-price="15">
                            <label for="topping8">ÈÆÆÂ•∂ (+$15)</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <label>Êï∏ÈáèÔºö</label>
                <input type="number" id="quantity" min="1" value="1" disabled>
                <button id="addBtn" disabled>Êñ∞Â¢ûÂà∞Ë®ÇÂñÆ</button>
            </div>
        </div>
        
        <!-- Âç≥ÊôÇË®ÇÂñÆË°®Ê†º -->
        <div class="table-container">
            <table id="orderTable">
                <thead>
                    <tr>
                        <th>ÊôÇÈñì</th>
                        <th>È°ßÂÆ¢ÂßìÂêç</th>
                        <th>ÂàÜÈ°û</th>
                        <th>ÂìÅÈ†Ö</th>
                        <th>ÁîúÂ∫¶</th>
                        <th>ÂÜ∞Â°ä</th>
                        <th>Âä†Êñô</th>
                        <th>ÂñÆÂÉπ</th>
                        <th>Êï∏Èáè</th>
                        <th>Â∞èË®à</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    <tr>
                        <td colspan="11" style="text-align: center; color: #666;">ËºâÂÖ•‰∏≠...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Áµ±Ë®àÊëòË¶Å -->
        <div class="summary">
            <h3>üìä Âç≥ÊôÇÁµ±Ë®à</h3>
            <div class="summary-item">
                <span>‰∏çÂêåÈ°ßÂÆ¢Êï∏Ôºö</span>
                <span id="uniqueCustomers">0</span>
            </div>
            <div class="summary-item">
                <span>Á∏ΩÂìÅÈ†ÖÊï∏Ôºö</span>
                <span id="totalItems">0</span>
            </div>
            <div class="summary-item">
                <span>Á∏ΩÊï∏ÈáèÔºö</span>
                <span id="totalQuantity">0</span>
            </div>
            <div class="summary-item">
                <span>Á∏ΩÈáëÈ°çÔºö</span>
                <span id="totalAmount">NT$ 0</span>
            </div>
        </div>
    </div>

    <script type="module">
        // ÂØÜÁ¢ºË®≠ÂÆöÔºàÊÇ®ÂèØ‰ª•‰øÆÊîπÈÄôÂÄãÂØÜÁ¢ºÔºâ
        const SYSTEM_PASSWORD = 'hy123';
        
        // Firebase Ë®≠ÂÆöÔºàÂ∑≤ÂÖßÂµåÔºâ
        const firebaseConfig = {
            "apiKey": "AIzaSyC6BlzAWm2PFBRJrtzySyI0spJrk-DIuvA",
            "authDomain": "order-collect-eb163.firebaseapp.com",
            "projectId": "order-collect-eb163",
            "storageBucket": "order-collect-eb163.firebasestorage.app",
            "messagingSenderId": "276173896243",
            "appId": "1:276173896243:web:e7cc9f400d4d509699c146",
            "measurementId": "G-2NCH0KCLRZ"
        };
        
        // ÂÖ®ÂüüËÆäÊï∏
        let db = null;
        let ordersRef = null;
        let unsubscribe = null;
        
        const menuData = {
            "ÂéüËêÉÂ∞èËå∂È§®": {
                "Â§úÈüªÁ¥ÖËå∂": 35,
                "ÈáëËê±ËúúÈ¶ôÁ¥ÖËå∂": 35,
                "ÈªÉÈáëÁÉèÈæçËå∂": 40,
                "ÂõõÂ≠£Êò•ÈùíËå∂": 35,
                "‰∏âÊ∫êËåâËéâÁ∂†Ëå∂": 35
            },
            "ÈÄ†Â∏ÇÂ∞èÁßòÂ¢É": {
                "ÈáëËê±ËúúÈ¶ôÁ¥ÖËå∂": 65,
                "Êò•ËäΩËúúÈ¶ôÈùí": 65,
                "‰∏âÊ∫êËåâËéâÁ∂†Ëå∂Áµ≤": 65,
                "ÈªÉÈáëÁÉèÈæçËúúÈ¶ôÂ•∂Ëå∂": 65,
                "Ê≥ïÂºèÂèØÂèØÈÆÆÂ•∂Ëå∂": 85,
                "ÁÑôÂíñÂï°ÊäπËå∂ÊãøÈêµ": 85,
                "ÈÆÆÊ¶®ËòãÊûúËúúÈ¶ôÂ•∂Ëå∂": 95
            },
            "ÈÆÆÊ¶®Â∞èÊ∏ÖÁø†": {
                "ÈÆÆÁôæÈ¶ôÁ∂†Ëå∂": 60,
                "ÁôæÈ¶ôÊ≥¢Ê≥¢Ëå∂": 70,
                "ÈÆÆÊ¶®Ê™∏Ê™¨Ëå∂": 70,
                "ÈùíÊ™∏Ê∞£Ê≥°Ëå∂": 55,
                "ÈÆÆÊ¶®Ê™∏Ê™¨Ëå∂": 55,
                "ËúÇËúúÊ™∏Ê™¨Ëå∂": 60,
                "ÈÆÆÊ¶®ËòãÊûúÁ¥ÖËå∂": 65,
                "Ê™∏Ê™¨Â§æÈùíËå∂": 55,
                "‰æØËå∂Ê™∏Ê™¨Á¥ÖËå∂": 60,
                "ÈáëËê±ËúúÈ¶ôÁ¥ÖËå∂": 60,
                "ÈÄ†Â∏ÇÊ∞¥ÊûúËå∂": 70,
                "ÈÆÆÊ¶®ËòãÊûúÁ¥ÖËå∂": 85
            },
            "ÈÜáÈüªÂ•∂Ëå∂": {
                "Â•∂Ëå∂": 50,
                "ÈªÉÈáëÁÉèÈæçÂ•∂Ëå∂": 55,
                "ÂÜ∞Ê∑áÊ∑ãÁ¥ÖËå∂": 50,
                "ÁèçÁè†Â•∂Ëå∂": 55,
                "Á¥ÖËå∂ÊãøÈêµ": 60,
                "ÁáïÈ∫•Â•∂Ëå∂": 65
            },
            "ÈÇÄËå∂Â∏Ç": {
                "ÈÄ†Â∏ÇËå∂Âáç": 45,
                "ÈÄ†Â∏ÇÈÆÆÂ•∂Ëå∂": 80,
                "ÈÄ†Â∏ÇÊó•ÂºèÂ•∂Ëå∂": 75,
                "ÈÄ†Â∏ÇÈ¶ôÊ™∏Ëå∂": 60,
                "ÈÄ†Â∏ÇËúÇËúúËå∂": 75
            },
            "ÁæéÂ¶ôÈôêÂÆö": {
                "ÁáíÁÉ§Ë≤ùÊÆºÂ•∂Ëå∂": 95,
                "ËäíÊûúËúúÈ¶ôÂ•∂Ëå∂": 95,
                "ËúÇËúúËäíÊûúÂ•∂Ëå∂": 95,
                "È¶ôËçâËúúÈ¶ôÂ•∂Ëå∂": 90
            }
        };

        // DOM ÂÖÉÁ¥†
        const loginPage = document.getElementById('loginPage');
        const mainPage = document.getElementById('mainPage');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const categorySelect = document.getElementById('categorySelect');
        const itemSelect = document.getElementById('itemSelect');
        const customerNameInput = document.getElementById('customerName');
        const optionsGroup = document.getElementById('optionsGroup');
        const sweetnessSelect = document.getElementById('sweetnessSelect');
        const iceSelect = document.getElementById('iceSelect');
        const quantityInput = document.getElementById('quantity');
        const addBtn = document.getElementById('addBtn');
        const orderTableBody = document.getElementById('orderTableBody');
        const lastUpdateSpan = document.getElementById('lastUpdate');

        // ÁôªÂÖ•ÂäüËÉΩ
        function checkPassword() {
            const inputPassword = passwordInput.value.trim();
            if (inputPassword === SYSTEM_PASSWORD) {
                localStorage.setItem('teaOrderAuth', 'true');
                showMainPage();
            } else {
                showError('ÂØÜÁ¢ºÈåØË™§ÔºåË´ãÈáçÊñ∞Ëº∏ÂÖ•');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function showError(message) {
            loginError.textContent = message;
            loginError.style.display = 'block';
        }

        function showMainPage() {
            loginPage.style.display = 'none';
            mainPage.style.display = 'block';
            initializeFirebase();
        }

        function logout() {
            localStorage.removeItem('teaOrderAuth');
            if (unsubscribe) {
                unsubscribe();
            }
            loginPage.style.display = 'block';
            mainPage.style.display = 'none';
            passwordInput.value = '';
            loginError.style.display = 'none';
        }

        // ÂàùÂßãÂåñ Firebase
        async function initializeFirebase() {
            try {
                statusIndicator.textContent = 'ÈÄ£Êé•‰∏≠...';
                statusIndicator.className = 'status-indicator status-loading';
                
                // ÂãïÊÖãËºâÂÖ• Firebase SDK
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
                const { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, getDocs } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                
                // Â∞á Firebase ÂáΩÊï∏Â≠òÁÇ∫ÂÖ®ÂüüËÆäÊï∏
                window.firebaseFunctions = { addDoc, deleteDoc, doc, getDocs };
                
                // ÂàùÂßãÂåñ Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                ordersRef = collection(db, 'orders');
                
                // Ë®≠ÂÆöÂç≥ÊôÇÁõ£ËÅΩ
                const q = query(ordersRef, orderBy('timestamp', 'desc'));
                unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const orders = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (!data.test) {  // ÊéíÈô§Ê∏¨Ë©¶Ë≥áÊñô
                            orders.push({
                                id: doc.id,
                                ...data
                            });
                        }
                    });
                    updateOrderTable(orders);
                    updateSummary(orders);
                    lastUpdateSpan.textContent = new Date().toLocaleTimeString();
                });
                
                statusIndicator.textContent = 'Â∑≤ÈÄ£Êé•';
                statusIndicator.className = 'status-indicator status-connected';
                
                setupEventListeners();
                
            } catch (error) {
                console.error('Firebase ÂàùÂßãÂåñÂ§±Êïó:', error);
                statusIndicator.textContent = 'ÈÄ£Êé•Â§±Êïó';
                statusIndicator.className = 'status-indicator status-disconnected';
            }
        }

        // Êñ∞Â¢ûË®ÇÂñÆ
        async function addOrder() {
            if (!db || !window.firebaseFunctions) {
                alert('Ë´ãÁ®çÂÄôÔºåÁ≥ªÁµ±Ê≠£Âú®ÈÄ£Êé•‰∏≠...');
                return;
            }
            
            const category = categorySelect.value;
            const item = itemSelect.value;
            const customerName = customerNameInput.value.trim();
            const quantity = parseInt(quantityInput.value);
            const basePrice = parseInt(itemSelect.selectedOptions[0].dataset.price);
            const sweetness = sweetnessSelect.value;
            const ice = iceSelect.value;
            
            if (!customerName) {
                alert('Ë´ãÂ°´ÂÖ•È°ßÂÆ¢ÂßìÂêçÔºÅ');
                customerNameInput.focus();
                return;
            }
            
            // Ë®àÁÆóÂä†ÊñôÂÉπÊ†º
            const toppings = [];
            let toppingPrice = 0;
            const toppingInputs = document.querySelectorAll('input[type="checkbox"]:checked');
            toppingInputs.forEach(input => {
                toppings.push(input.value);
                toppingPrice += parseInt(input.dataset.price);
            });
            
            const totalPrice = basePrice + toppingPrice;
            const toppingsText = toppings.length > 0 ? toppings.join(', ') : 'ÁÑ°';

            if (category && item && quantity > 0) {
                try {
                    addBtn.disabled = true;
                    addBtn.textContent = 'Êñ∞Â¢û‰∏≠...';
                    
                    const orderData = {
                        customerName: customerName,
                        category: category,
                        item: item,
                        sweetness: sweetness,
                        ice: ice,
                        toppings: toppingsText,
                        basePrice: basePrice,
                        toppingPrice: toppingPrice,
                        totalPrice: totalPrice,
                        quantity: quantity,
                        subtotal: totalPrice * quantity,
                        timestamp: new Date()
                    };
                    
                    await window.firebaseFunctions.addDoc(ordersRef, orderData);
                    
                    // ÈáçÁΩÆË°®ÂñÆ
                    customerNameInput.value = '';
                    quantityInput.value = 1;
                    sweetnessSelect.value = 'Ê≠£Â∏∏Áîú';
                    iceSelect.value = 'Ê≠£Â∏∏ÂÜ∞';
                    toppingInputs.forEach(input => input.checked = false);
                    
                } catch (error) {
                    console.error('Êñ∞Â¢ûË®ÇÂñÆÂ§±Êïó:', error);
                    alert('Êñ∞Â¢ûË®ÇÂñÆÂ§±ÊïóÔºåË´ãÈáçË©¶');
                } finally {
                    addBtn.disabled = false;
                    addBtn.textContent = 'Êñ∞Â¢ûÂà∞Ë®ÇÂñÆ';
                }
            }
        }

        // Âà™Èô§Ë®ÇÂñÆ
        async function removeOrder(orderId) {
            if (!db || !window.firebaseFunctions) return;
            
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜË®ÇÂñÆÂóéÔºü')) {
                try {
                    await window.firebaseFunctions.deleteDoc(window.firebaseFunctions.doc(db, 'orders', orderId));
                } catch (error) {
                    console.error('Âà™Èô§Ë®ÇÂñÆÂ§±Êïó:', error);
                    alert('Âà™Èô§Ë®ÇÂñÆÂ§±ÊïóÔºåË´ãÈáçË©¶');
                }
            }
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâË®ÇÂñÆ
        async function clearAllOrders() {
            if (!db || !window.firebaseFunctions) return;
            
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâË®ÇÂñÆÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ')) {
                try {
                    const snapshot = await window.firebaseFunctions.getDocs(ordersRef);
                    const deletePromises = [];
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (!data.test) {  // ‰∏çÂà™Èô§Ê∏¨Ë©¶Ë≥áÊñô
                            deletePromises.push(window.firebaseFunctions.deleteDoc(doc.ref));
                        }
                    });
                    
                    await Promise.all(deletePromises);
                    alert('ÊâÄÊúâË®ÇÂñÆÂ∑≤Ê∏ÖÁ©∫');
                } catch (error) {
                    console.error('Ê∏ÖÁ©∫Ë®ÇÂñÆÂ§±Êïó:', error);
                    alert('Ê∏ÖÁ©∫Ë®ÇÂñÆÂ§±ÊïóÔºåË´ãÈáçË©¶');
                }
            }
        }

        // Êõ¥Êñ∞Ë®ÇÂñÆË°®Ê†º
        function updateOrderTable(orders) {
            if (orders.length === 0) {
                orderTableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">ÁõÆÂâçÊ≤íÊúâË®ÇÂñÆ</td></tr>';
                return;
            }

            let html = '';
            orders.forEach((order, index) => {
                const priceDetail = order.toppingPrice > 0 ? 
                    `NT$ ${order.basePrice} + ${order.toppingPrice}` : 
                    `NT$ ${order.basePrice}`;
                
                const orderTime = order.timestamp ? 
                    new Date(order.timestamp.seconds * 1000).toLocaleTimeString() : 
                    'Êú™Áü•';
                
                html += `
                    <tr>
                        <td>${orderTime}</td>
                        <td>${order.customerName}</td>
                        <td>${order.category}</td>
                        <td>${order.item}</td>
                        <td>${order.sweetness}</td>
                        <td>${order.ice}</td>
                        <td>${order.toppings}</td>
                        <td>${priceDetail}</td>
                        <td>${order.quantity}</td>
                        <td>NT$ ${order.subtotal}</td>
                        <td>
                            <button class="remove-btn" data-order-id="${order.id}">Âà™Èô§</button>
                        </td>
                    </tr>
                `;
            });

            const totalAmount = orders.reduce((sum, order) => sum + order.subtotal, 0);
            const totalQuantity = orders.reduce((sum, order) => sum + order.quantity, 0);
            
            html += `
                <tr class="total-row">
                    <td colspan="8">Á∏ΩË®à</td>
                    <td>${totalQuantity}</td>
                    <td>NT$ ${totalAmount}</td>
                    <td>-</td>
                </tr>
            `;

            orderTableBody.innerHTML = html;
            
            // ÁÇ∫Âà™Èô§ÊåâÈàïÊ∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
            const removeButtons = orderTableBody.querySelectorAll('.remove-btn');
            removeButtons.forEach(button => {
                if (button.dataset.orderId) {
                    button.addEventListener('click', () => removeOrder(button.dataset.orderId));
                }
            });
        }

        // Êõ¥Êñ∞Áµ±Ë®àÊëòË¶Å
        function updateSummary(orders) {
            const totalItems = orders.length;
            const totalQuantity = orders.reduce((sum, order) => sum + order.quantity, 0);
            const totalAmount = orders.reduce((sum, order) => sum + order.subtotal, 0);
            const uniqueCustomers = new Set(orders.map(order => order.customerName)).size;

            document.getElementById('uniqueCustomers').textContent = uniqueCustomers;
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalQuantity').textContent = totalQuantity;
            document.getElementById('totalAmount').textContent = `NT$ ${totalAmount}`;
        }

        // ÂåØÂá∫ CSV
        function exportToCSV() {
            const table = document.getElementById('orderTable');
            const rows = table.querySelectorAll('tbody tr');
            
            if (rows.length <= 1) {
                alert('Ê≤íÊúâË®ÇÂñÆË≥áÊñôÂèØ‰ª•ÂåØÂá∫');
                return;
            }

            let csv = 'ÊôÇÈñì,È°ßÂÆ¢ÂßìÂêç,ÂàÜÈ°û,ÂìÅÈ†Ö,ÁîúÂ∫¶,ÂÜ∞Â°ä,Âä†Êñô,Âü∫Êú¨ÂÉπÊ†º,Âä†ÊñôÂÉπÊ†º,Á∏ΩÂñÆÂÉπ,Êï∏Èáè,Â∞èË®à\n';
            
            for (let i = 0; i < rows.length - 1; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td');
                
                if (cells.length >= 10) {
                    const time = cells[0].textContent.trim();
                    const customerName = cells[1].textContent.trim();
                    const category = cells[2].textContent.trim();
                    const item = cells[3].textContent.trim();
                    const sweetness = cells[4].textContent.trim();
                    const ice = cells[5].textContent.trim();
                    const toppings = cells[6].textContent.trim();
                    const priceText = cells[7].textContent.trim();
                    const quantity = cells[8].textContent.trim();
                    const subtotal = cells[9].textContent.replace('NT$ ', '').trim();
                    
                    let basePrice = '';
                    let toppingPrice = '0';
                    let totalPrice = '';
                    
                    if (priceText.includes(' + ')) {
                        const prices = priceText.split(' + ');
                        basePrice = prices[0].replace('NT$ ', '');
                        toppingPrice = prices[1];
                        totalPrice = (parseInt(basePrice) + parseInt(toppingPrice)).toString();
                    } else {
                        basePrice = priceText.replace('NT$ ', '');
                        totalPrice = basePrice;
                    }
                    
                    csv += `"${time}","${customerName}","${category}","${item}","${sweetness}","${ice}","${toppings}",${basePrice},${toppingPrice},${totalPrice},${quantity},${subtotal}\n`;
                }
            }

            const totalRow = rows[rows.length - 1];
            if (totalRow && totalRow.classList.contains('total-row')) {
                const totalCells = totalRow.querySelectorAll('td');
                if (totalCells.length >= 3) {
                    const totalQuantity = totalCells[totalCells.length - 2].textContent.trim();
                    const totalAmount = totalCells[totalCells.length - 1].textContent.replace('NT$ ', '').trim();
                    csv += `Á∏ΩË®à,,,,,,,,,,${totalQuantity},${totalAmount}\n`;
                }
            }

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Ëå∂È£≤Ë®ÇÂñÆ_${new Date().toISOString().slice(0, 10)}.csv`);
            link.click();
        }

        // Ë®≠ÂÆö‰∫ã‰ª∂Áõ£ËÅΩÂô®
        function setupEventListeners() {
            categorySelect.addEventListener('change', function() {
                const category = this.value;
                itemSelect.innerHTML = '<option value="">Ë´ãÈÅ∏ÊìáÂìÅÈ†Ö</option>';
                
                if (category && menuData[category]) {
                    Object.keys(menuData[category]).forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;
                        option.textContent = `${item} - NT$ ${menuData[category][item]}`;
                        option.dataset.price = menuData[category][item];
                        itemSelect.appendChild(option);
                    });
                    itemSelect.disabled = false;
                    customerNameInput.disabled = false;
                } else {
                    itemSelect.disabled = true;
                    customerNameInput.disabled = true;
                    optionsGroup.style.display = 'none';
                    quantityInput.disabled = true;
                    addBtn.disabled = true;
                }
            });

            itemSelect.addEventListener('change', function() {
                if (this.value) {
                    optionsGroup.style.display = 'block';
                    quantityInput.disabled = false;
                    addBtn.disabled = false;
                } else {
                    optionsGroup.style.display = 'none';
                    quantityInput.disabled = true;
                    addBtn.disabled = true;
                }
            });

            addBtn.addEventListener('click', addOrder);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('clearBtn').addEventListener('click', clearAllOrders);
        }

        // ‰∫ã‰ª∂Áõ£ËÅΩÂô®Ë®≠ÂÆö
        loginBtn.addEventListener('click', checkPassword);
        logoutBtn.addEventListener('click', logout);
        
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÊ™¢Êü•ÊòØÂê¶Â∑≤ÁôªÂÖ•
        window.addEventListener('load', function() {
            const isAuthenticated = localStorage.getItem('teaOrderAuth') === 'true';
            if (isAuthenticated) {
                showMainPage();
            } else {
                passwordInput.focus();
            }
        });

        // È†ÅÈù¢ÈóúÈñâÊôÇÊ∏ÖÁêÜÁõ£ËÅΩÂô®
        window.addEventListener('beforeunload', function() {
            if (unsubscribe) {
                unsubscribe();
            }
        });

        // ÂÖ®ÂüüÂáΩÊï∏
        window.removeOrder = removeOrder;
    </script>
</body>
</html>