<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§‹ å¤šåº—å®¶èŒ¶é£²è¨‚è³¼ç³»çµ±</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 40px;
            text-align: center;
        }
        
        .login-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
        }
        
        .error-message {
            color: #dc3545;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .role-selector {
            margin-bottom: 20px;
        }
        
        .role-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }
        
        .role-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }
        
        .admin-panel {
            max-width: 600px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 40px;
            display: none;
        }
        
        .admin-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .store-selection {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .store-selection h3 {
            margin: 0 0 15px 0;
            color: #2d5a2d;
        }
        
        .store-option {
            margin-bottom: 10px;
        }
        
        .store-option input[type="radio"] {
            margin-right: 10px;
        }
        
        .store-option label {
            font-size: 16px;
            cursor: pointer;
        }
        
        .admin-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .admin-buttons button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .store-name {
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .admin-switch {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .admin-switch:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .status-indicator {
            position: absolute;
            top: 70px;
            left: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-connected {
            background: #28a745;
            color: white;
        }
        
        .status-disconnected {
            background: #dc3545;
            color: white;
        }
        
        .status-loading {
            background: #ffc107;
            color: #333;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .options-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .option-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .option-section label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .toppings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 5px;
        }
        
        .topping-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        
        .topping-item input[type="checkbox"] {
            margin: 0;
        }
        
        .control-group label {
            font-weight: bold;
            min-width: 80px;
        }
        
        select, input, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        select {
            min-width: 200px;
        }
        
        input[type="number"] {
            width: 80px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .admin-controls {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .admin-controls-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2d5a2d;
        }
        
        .table-container {
            overflow-x: auto;
            padding: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        tr:hover {
            background: #e9ecef;
        }
        
        .total-row {
            background: #e3f2fd !important;
            font-weight: bold;
        }
        
        .summary {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .summary h3 {
            margin: 0 0 10px 0;
            color: #2d5a2d;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        .notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
            color: #856404;
        }
        
        @media (max-width: 768px) {
            .login-container, .admin-panel {
                margin: 20px auto;
                padding: 30px 20px;
            }
            
            .container {
                margin: 10px;
                border-radius: 0;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group label {
                min-width: auto;
            }
            
            select, input {
                min-width: auto;
                width: 100%;
            }
            
            .admin-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥é é¢ -->
    <div id="loginPage" class="login-container">
        <div class="login-title">ğŸ§‹ å¤šåº—å®¶èŒ¶é£²è¨‚è³¼ç³»çµ±</div>
        <div class="login-subtitle">è«‹é¸æ“‡èº«ä»½ä¸¦è¼¸å…¥å¯†ç¢¼</div>
        
        <div class="role-selector">
            <label>é¸æ“‡èº«ä»½ï¼š</label>
            <select id="roleSelect">
                <option value="user">ä¸€èˆ¬ä½¿ç”¨è€…</option>
                <option value="admin">ç®¡ç†å“¡</option>
            </select>
        </div>
        
        <input type="password" id="passwordInput" class="password-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
        <button id="loginBtn" class="login-btn">ç™»å…¥</button>
        <div id="loginError" class="error-message" style="display: none;"></div>
    </div>

    <!-- ç®¡ç†å“¡é¢æ¿ -->
    <div id="adminPanel" class="admin-panel">
        <div class="admin-title">ğŸ”§ ç®¡ç†å“¡æ§åˆ¶é¢æ¿</div>
        
        <div class="store-selection">
            <h3>é¸æ“‡ä»Šæ—¥ç‡Ÿæ¥­åº—å®¶ï¼š</h3>
            <div class="store-option">
                <input type="radio" id="store1" name="selectedStore" value="å°æ¾„å¸‚">
                <label for="store1">ğŸ§‹ å°æ¾„å¸‚</label>
            </div>
            <div class="store-option">
                <input type="radio" id="store2" name="selectedStore" value="50åµ">
                <label for="store2">ğŸ§‹ 50åµ</label>
            </div>
            <div class="store-option">
                <input type="radio" id="store2" name="selectedStore" value="å—æµ·èŒ¶é“">
                <label for="store2">ğŸ§‹ å—æµ·èŒ¶é“</label>
            </div>
        </div>
        
        <div class="admin-buttons">
            <button id="confirmStoreBtn" class="btn-primary">ç¢ºèªä¸¦é–‹å§‹ç‡Ÿæ¥­</button>
            <button id="backToLoginBtn" class="btn-secondary">è¿”å›ç™»å…¥</button>
        </div>
    </div>

    <!-- ä¸»è¦ç³»çµ±é é¢ -->
    <div id="mainPage" class="container">
        <div class="header">
            <h1>ğŸ§‹ å¤šåº—å®¶èŒ¶é£²è¨‚è³¼ç³»çµ±</h1>
            <div id="currentStoreName" class="store-name">è¼‰å…¥ä¸­...</div>
            <p>å³æ™‚åŒæ­¥ï¼Œå¤šäººå”ä½œé»é¤</p>
            <button id="adminSwitchBtn" class="admin-switch">ç®¡ç†å“¡æ¨¡å¼</button>
            <button id="logoutBtn" class="logout-btn">ç™»å‡º</button>
            <div id="statusIndicator" class="status-indicator status-loading">é€£æ¥ä¸­...</div>
        </div>
        
        <!-- ç®¡ç†è€…æ§åˆ¶é¢æ¿ -->
        <div class="admin-controls" id="adminControls" style="display: none;">
            <div class="admin-controls-title">ğŸ“Š ç®¡ç†è€…æ§åˆ¶é¢æ¿</div>
            <div class="control-group">
                <button id="exportBtn" class="btn-success">åŒ¯å‡ºæ‰€æœ‰è¨‚å–® CSV</button>
                <button id="clearBtn" class="btn-danger">æ¸…ç©ºæ‰€æœ‰è¨‚å–®</button>
                <span style="margin-left: 20px; font-weight: bold;">å³æ™‚æ›´æ–°ï¼š<span id="lastUpdate">-</span></span>
            </div>
        </div>
        
        <!-- é»é¤è¡¨å–® -->
        <div class="controls">
            <div class="control-group">
                <label>é¸æ“‡åˆ†é¡ï¼š</label>
                <select id="categorySelect">
                    <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>é¸æ“‡å“é …ï¼š</label>
                <select id="itemSelect" disabled>
                    <option value="">è«‹å…ˆé¸æ“‡åˆ†é¡</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>é¡§å®¢å§“åï¼š</label>
                <input type="text" id="customerName" placeholder="è«‹è¼¸å…¥é¡§å®¢å§“å" disabled style="min-width: 150px;">
            </div>
            
            <div class="options-group" id="optionsGroup" style="display: none;">
                <div class="option-section">
                    <label>ç”œåº¦ï¼š</label>
                    <select id="sweetnessSelect">
                        <option value="æ­£å¸¸ç”œ">æ­£å¸¸ç”œ</option>
                        <option value="å°‘ç³–">å°‘ç³–</option>
                        <option value="åŠç³–">åŠç³–</option>
                        <option value="å¾®ç³–">å¾®ç³–</option>
                        <option value="1åˆ†ç³–">1åˆ†ç³–</option>
                        <option value="ç„¡ç³–">ç„¡ç³–</option>
                    </select>
                </div>
                
                <div class="option-section">
                    <label>å†°å¡Šï¼š</label>
                    <select id="iceSelect">
                        <option value="æ­£å¸¸å†°">æ­£å¸¸å†°</option>
                        <option value="å°‘å†°">å°‘å†°</option>
                        <option value="å¾®å†°">å¾®å†°</option>
                        <option value="å»å†°">å»å†°</option>
                        <option value="å®Œå…¨å»å†°">å®Œå…¨å»å†°</option>
                        <option value="æº«é£²">æº«é£²</option>
                        <option value="ç†±é£²">ç†±é£²</option>
                    </select>
                </div>
                
                <div class="option-section">
                    <label>åŠ æ–™ï¼š</label>
                    <div class="toppings-grid" id="toppingsGrid">
                        <!-- åŠ æ–™é¸é …æœƒæ ¹æ“šåº—å®¶å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div id="specialNotice" class="notice" style="display: none;">
                    <strong>ç‰¹åˆ¥èªªæ˜ï¼š</strong>
                    <span id="noticeText"></span>
                </div>
            </div>
            
            <div class="control-group">
                <label>æ•¸é‡ï¼š</label>
                <input type="number" id="quantity" min="1" value="1" disabled>
                <button id="addBtn" disabled>æ–°å¢åˆ°è¨‚å–®</button>
            </div>
        </div>
        
        <!-- å³æ™‚è¨‚å–®è¡¨æ ¼ -->
        <div class="table-container">
            <table id="orderTable">
                <thead>
                    <tr>
                        <th>æ™‚é–“</th>
                        <th>é¡§å®¢å§“å</th>
                        <th>åˆ†é¡</th>
                        <th>å“é …</th>
                        <th>ç”œåº¦</th>
                        <th>å†°å¡Š</th>
                        <th>åŠ æ–™</th>
                        <th>å–®åƒ¹</th>
                        <th>æ•¸é‡</th>
                        <th>å°è¨ˆ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    <tr>
                        <td colspan="11" style="text-align: center; color: #666;">è¼‰å…¥ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- çµ±è¨ˆæ‘˜è¦ -->
        <div class="summary">
            <h3>ğŸ“Š å³æ™‚çµ±è¨ˆ</h3>
            <div class="summary-item">
                <span>ä¸åŒé¡§å®¢æ•¸ï¼š</span>
                <span id="uniqueCustomers">0</span>
            </div>
            <div class="summary-item">
                <span>ç¸½å“é …æ•¸ï¼š</span>
                <span id="totalItems">0</span>
            </div>
            <div class="summary-item">
                <span>ç¸½æ•¸é‡ï¼š</span>
                <span id="totalQuantity">0</span>
            </div>
            <div class="summary-item">
                <span>ç¸½é‡‘é¡ï¼š</span>
                <span id="totalAmount">NT$ 0</span>
            </div>
        </div>
    </div>

    <script type="module">
        // å¯†ç¢¼è¨­å®š
        const PASSWORDS = {
            user: 'hy123',
            admin: 'admin123'
        };
        
        // Firebase è¨­å®š
        const firebaseConfig = {
            "apiKey": "AIzaSyC6BlzAWm2PFBRJrtzySyI0spJrk-DIuvA",
            "authDomain": "order-collect-eb163.firebaseapp.com",
            "projectId": "order-collect-eb163",
            "storageBucket": "order-collect-eb163.firebasestorage.app",
            "messagingSenderId": "276173896243",
            "appId": "1:276173896243:web:e7cc9f400d4d509699c146",
            "measurementId": "G-2NCH0KCLRZ"
        };
        
        // å…¨åŸŸè®Šæ•¸
        let db = null;
        let ordersRef = null;
        let storeConfigRef = null;
        let unsubscribe = null;
        let storeUnsubscribe = null;
        let currentUserRole = null;
        let currentStore = null;
        
        // åº—å®¶èœå–®è³‡æ–™
        const storeMenus = {
            "å°æ¾„å¸‚": {
                name: "ğŸ§‹ å°æ¾„å¸‚",
                categories: {
                    "åŸæ²å°èŒ¶åœ’": {
                        "å¾©åˆ»ç´…èŒ¶": 35,
                        "é‡‘è±èœœé¦™ç´…èŒ¶": 35,
                        "é»ƒé‡‘ç©€è•éº¥": 40,
                        "å››å­£æ˜¥é’èŒ¶": 35,
                        "ä¸‰çª¨èŒ‰è‰ç¶ èŒ¶": 35
                    },
                    "æ¾„å¸‚å°ç‰§å ´": {
                        "é‡‘è±é®®å¥¶èŒ¶": 65,
                        "æ˜¥èŠ½é®®å¥¶é’": 65,
                        "ä¸‰çª¨èŒ‰è‰é®®å¥¶ç¶ ": 65,
                        "é»ƒé‡‘ç©€è•éº¥é®®å¥¶èŒ¶": 65,
                        "æ³•å¼å¯å¯é®®å¥¶èŒ¶": 85,
                        "éœå²¡æŠ¹èŒ¶é®®å¥¶": 85,
                        "é®®æ¦¨è˜‹æœæ­è•¾": 95
                    },
                    "é®®æ¡å°æ¾„æœ": {
                        "é®®ç™¾é¦™æœç¶ ": 60,
                        "ç™¾é¦™æ³¢æ³¢ç¶ ": 70,
                        "é®®æŸ³æ©™ç¶ èŒ¶": 70,
                        "é’é‡€è„†æ¢…ç¶ ": 55,
                        "é®®æ¦¨æª¸æª¬ç´…èŒ¶": 55,
                        "é®®æ¦¨æª¸æª¬ç¶ èŒ¶": 55,
                        "é®®æ¦¨æª¸æª¬é’èŒ¶": 55,
                        "é®®ç”˜è”—é’èŒ¶": 60,
                        "é®®ç”˜è”—æª¸æª¬": 65,
                        "ç¿¡ç¿ å‡æª¸æª¬": 55,
                        "æ¡ƒæ°£æª¸æª¬": 60,
                        "é‡‘é‘½èœœé³³æ¢¨": 60,
                        "æ¾„å¸‚æ°´æœèŒ¶": 70,
                        "é®®æ¦¨è˜‹æœç´…ç‰": 85,
                        "é®®æ¦¨è˜‹æœç¶ èŒ¶": 85,
                        "é®®æ¦¨è˜‹æœé’èŒ¶": 85
                    },
                    "é†‡éŸ»å¥¶èŒ¶": {
                        "å¾©åˆ»å¥¶èŒ¶": 50,
                        "å¥¶èŒ¶(ç¶ )": 50,
                        "å¥¶èŒ¶(é’)": 50,
                        "é»ƒé‡‘ç©€è•éº¥å¥¶èŒ¶": 55,
                        "å†°æ·‡æ·‹ç´…èŒ¶": 50,
                        "çç å¥¶èŒ¶": 55,
                        "ç¿¡ç¿ å‡å¥¶ç¶ ": 60,
                        "æ³¢æ³¢å››å­£å¥¶é’": 65
                    },
                    "å¡©é›ªæ¾„å¸‚": {
                        "å¡©é›ªé»ƒé‡‘ç©€è•éº¥": 65,
                        "å¡©é›ªé‡‘è±èœœé¦™ç´…": 60,
                        "å¡©é›ªä¸‰çª¨èŒ‰è‰ç¶ ": 60,
                        "å¡©é›ªå››å­£æ˜¥é’": 60,
                        "å¡©é›ªå¯å¯è„†ç‰‡": 95,
                        "å¡©é›ªæŠ¹èŒ¶ä¹‹å£«": 95
                    },
                    "æ¾„å‡æ¾„å¸‚": {
                        "æ¾„å‡èŒ‰è‰ç¶ ": 45,
                        "æ¾„å‡æŸ³æ©™ç¶ ": 80,
                        "æ¾„å‡ç”˜è”—æª¸æª¬": 75,
                        "æ¾„å‡é¦™æª¸ç¶ ": 60,
                        "æ¾„å‡é®®å¥¶ç¶ ": 75
                    },
                    "å­£ç¯€é™å®š": {
                        "å››å­£èŠ’æœé’èŒ¶": 70,
                        "ä¸‰çª¨èŠ’æœç¶ èŒ¶": 70,
                        "æ¥Šæç”˜éœ²": 95,
                        "èŠ’æœé›ªéœœæ­è•¾": 95,
                        "å¡©é›ªèŠ’æœèŠå£«": 95,
                        "å¥‡ç•°æœæ³¢æ³¢": 90
                    }
                },
                toppings: [
                    { name: "çç ", price: 10 },
                    { name: "æ¤°æœ", price: 10 },
                    { name: "å¸ƒä¸", price: 15 },
                    { name: "ä»™è‰", price: 10 },
                    { name: "æ„›ç‰", price: 15 },
                    { name: "è˜†è–ˆ", price: 10 },
                    { name: "å¥¶è“‹", price: 20 },
                    { name: "é®®å¥¶", price: 15 }
                ]
            },
            "50åµ": {
                name: "ğŸ§‹ 50åµ",
                categories: {
                    "è³å‘³èŒ¶å“": {
                        "è’¸é’ç¶ èŒ¶": 35,
                        "çƒé¾ç´…èŒ¶": 35,
                        "é«˜å±±çƒé¾é’": 35,
                        "å¥¶é¦™é‡‘è±èŒ¶": 40,
                        "ç†Ÿé¦™çƒé¾èŒ¶": 40,
                        "é¾ç„™åŠŸå¤«èŒ¶": 40
                    },
                    "é®®å¥¶èŒ¶ç³»åˆ—": {
                        "é®®å¥¶ç´…èŒ¶": 60,
                        "é®®å¥¶ç¶ èŒ¶": 60,
                        "é‡‘è±é®®å¥¶èŒ¶": 65,
                        "ç†Ÿé¦™é®®å¥¶èŒ¶": 65,
                        "é¾ç„™é®®å¥¶èŒ¶": 65
                    },
                    "é¤Šæ¨‚å¤šç³»åˆ—": {
                        "é¤Šæ¨‚å¤šç¶ èŒ¶": 55,
                        "é¤Šæ¨‚å¤šé’èŒ¶": 55,
                        "é¤Šæ¨‚å¤šé‡‘è±": 60
                    },
                    "èœ‚èœœç³»åˆ—": {
                        "èœ‚èœœç´…èŒ¶": 55,
                        "èœ‚èœœç¶ èŒ¶": 55,
                        "ç´…èŒ¶é›ªæ³¡": 35,
                        "å¥¶èŒ¶é›ªæ³¡": 50,
                        "å¥¶ç¶ é›ªæ³¡": 50,
                        "å·§å…‹åŠ›é›ªæ³¡": 55
                    },
                    "æ‹›ç‰Œç³»åˆ—": {
                        "50åµæ‹›ç‰Œ": 50,
                        "é¤Šæ¨‚å¤šç¶ èŒ¶": 45,
                        "å¤šå¤šç¶ èŒ¶": 45,
                        "æª¸æª¬é¤Šæ¨‚å¤š": 50,
                        "è˜†è–ˆèœœ": 40,
                        "æ„›ç‰æª¸æª¬": 45
                    }
                },
                toppings: [
                    { name: "çç ", price: 10 },
                    { name: "æ¤°æœ", price: 10 },
                    { name: "å¸ƒä¸", price: 15 },
                    { name: "ä»™è‰", price: 10 },
                    { name: "æ„›ç‰", price: 10 },
                    { name: "è˜†è–ˆ", price: 10 },
                    { name: "æ³¢éœ¸", price: 10 },
                    { name: "å¯’å¤©", price: 10 }
                ]
            },
            "å—æµ·èŒ¶é“": {
                name: "ğŸ§‹ å—æµ·èŒ¶é“",
                categories: {
                    "ç¾æ³¡èŒ¶é£²ç³»åˆ—-é‡‘è±èŒ¶": {
                        "é¹¿è°·é‡‘è±": 45,
                        "æ‰æ—æºªé‡‘è±": 50,
                        "é˜¿é‡Œå±±é‡‘è±": 60
                    },
                    "ç¾æ³¡èŒ¶é£²ç³»åˆ—-ç†±çƒé¾": {
                        "é¹¿è°·ç†±çƒé¾": 50,
                        "æ‰æ—æºªç†±çƒé¾": 55,
                        "é˜¿é‡Œå±±ç†±çƒé¾": 65
                    },
                    "ç¾æ³¡èŒ¶é£²ç³»åˆ—-çƒé¾é’": {
                        "é¹¿è°·çƒé¾é’": 45,
                        "æ‰æ—æºªçƒé¾é’": 50,
                        "é˜¿é‡Œå±±çƒé¾é’": 60,
                        "æ¢¨å±±çƒé¾é’": 85
                    },
                    "ç¾æ³¡èŒ¶é£²ç³»åˆ—-é¾ç„™èŒ¶": {
                        "é¹¿è°·é¾ç„™èŒ¶": 55,
                        "æ‰æ—æºªé¾ç„™èŒ¶": 60,
                        "é˜¿é‡Œå±±é¾ç„™èŒ¶": 75,
                        "æ¢¨å±±é¾ç„™èŒ¶": 95
                    },
                    "ç¾æ³¡èŒ¶é£²ç³»åˆ—-çª¨èŠ±èŒ¶": {
                        "æ¡‚èŠ±çƒé¾": 60,
                        "èŒ‰è‰åŒ…ç¨®": 55
                    },
                    "ç¾æ³¡èŒ¶é£²ç³»åˆ—-ç†ŸæˆèŒ¶": {
                        "é­šæ± ç´…ç‰": 60,
                        "ç‘ç©—èœœé¦™ç´…èŒ¶": 60,
                        "å³¨çœ‰æ±æ–¹ç¾äºº": 60
                    },
                    "åŸèŒ¶èª¿é£²ç³»åˆ—-ç‡Ÿå‘³èŒ¶å“": {
                        "è’¸é’ç¶ èŒ¶": 35,
                        "çƒé¾ç´…èŒ¶": 35,
                        "é«˜å±±çƒé¾é’": 35,
                        "å¥¶é¦™é‡‘è±èŒ¶": 40,
                        "ç†Ÿé¦™çƒé¾èŒ¶": 40,
                        "é¾ç„™åŠŸå¤«èŒ¶": 40
                    },
                    "åŸèŒ¶èª¿é£²ç³»åˆ—-èœ‚èœœç³»åˆ—": {
                        "èœ‚èœœç´…èŒ¶": 55,
                        "èœ‚èœœç¶ èŒ¶": 55,
                        "èœ‚èœœé‡‘è±èŒ¶": 60,
                        "èœ‚èœœé®®å¥¶ç´…èŒ¶": 80,
                        "èœ‚èœœé®®å¥¶ç¶ èŒ¶": 80,
                        "èœ‚èœœé®®å¥¶é‡‘è±": 85,
                        "èœ‚èœœé®®å¥¶é¾ç„™": 85
                    },
                    "åŸèŒ¶èª¿é£²ç³»åˆ—-é®®å¥¶èŒ¶ç³»åˆ—": {
                        "é®®å¥¶ç´…èŒ¶": 60,
                        "é®®å¥¶ç¶ èŒ¶": 60,
                        "é‡‘è±é®®å¥¶èŒ¶": 65,
                        "ç†Ÿé¦™é®®å¥¶èŒ¶": 65,
                        "é¾ç„™é®®å¥¶èŒ¶": 65
                    },
                    "åŸèŒ¶èª¿é£²ç³»åˆ—-é¤Šæ¨‚å¤šç³»åˆ—": {
                        "é¤Šæ¨‚å¤šç¶ èŒ¶": 55,
                        "é¤Šæ¨‚å¤šé’èŒ¶": 55,
                        "é¤Šæ¨‚å¤šé‡‘è±": 60
                    },
                    "å°ç£æœé¦™ç³»åˆ—": {
                        "æª¸æª¬ç´…èŒ¶": 55,
                        "æª¸æª¬ç¶ èŒ¶": 55,
                        "èœ‚èœœæª¸æª¬": 70,
                        "æŸ³ä¸ç¶ èŒ¶": 65,
                        "æŸ³ä¸é’èŒ¶": 65,
                        "æŸ³ä¸é‡‘è±": 70
                    },
                    "å†¬ç“œèŒ¶ç³»åˆ—": {
                        "å†¬ç“œèŒ¶": 35,
                        "å†¬ç“œé’èŒ¶": 50,
                        "å†¬ç“œæª¸æª¬": 55,
                        "å†¬ç“œé®®å¥¶": 60
                    }
                },
                toppings: [
                    { name: "çç ", price: 10 },
                    { name: "æ¤°æœ", price: 10 },
                    { name: "å¸ƒä¸", price: 15 },
                    { name: "ä»™è‰", price: 15 }
                ]
            }
        };

        // DOM å…ƒç´ 
        const loginPage = document.getElementById('loginPage');
        const adminPanel = document.getElementById('adminPanel');
        const mainPage = document.getElementById('mainPage');
        const roleSelect = document.getElementById('roleSelect');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const confirmStoreBtn = document.getElementById('confirmStoreBtn');
        const backToLoginBtn = document.getElementById('backToLoginBtn');
        const adminSwitchBtn = document.getElementById('adminSwitchBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const currentStoreName = document.getElementById('currentStoreName');
        const statusIndicator = document.getElementById('statusIndicator');
        const categorySelect = document.getElementById('categorySelect');
        const itemSelect = document.getElementById('itemSelect');
        const customerNameInput = document.getElementById('customerName');
        const optionsGroup = document.getElementById('optionsGroup');
        const sweetnessSelect = document.getElementById('sweetnessSelect');
        const iceSelect = document.getElementById('iceSelect');
        const toppingsGrid = document.getElementById('toppingsGrid');
        const quantityInput = document.getElementById('quantity');
        const addBtn = document.getElementById('addBtn');
        const orderTableBody = document.getElementById('orderTableBody');
        const lastUpdateSpan = document.getElementById('lastUpdate');
        const specialNotice = document.getElementById('specialNotice');
        const noticeText = document.getElementById('noticeText');

        // ç™»å…¥åŠŸèƒ½
        function checkPassword() {
            const selectedRole = roleSelect.value;
            const inputPassword = passwordInput.value.trim();
            
            if (inputPassword === PASSWORDS[selectedRole]) {
                currentUserRole = selectedRole;
                localStorage.setItem('teaOrderAuth', JSON.stringify({
                    role: selectedRole,
                    timestamp: Date.now()
                }));
                
                if (selectedRole === 'admin') {
                    showAdminPanel();
                } else {
                    loadCurrentStore();
                }
            } else {
                showError('å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function showError(message) {
            loginError.textContent = message;
            loginError.style.display = 'block';
        }

        function showAdminPanel() {
            loginPage.style.display = 'none';
            adminPanel.style.display = 'block';
            loadStoreSelection();
        }

        function showMainPage() {
            loginPage.style.display = 'none';
            adminPanel.style.display = 'none';
            mainPage.style.display = 'block';
            initializeFirebase();
        }

        function logout() {
            localStorage.removeItem('teaOrderAuth');
            if (unsubscribe) unsubscribe();
            if (storeUnsubscribe) storeUnsubscribe();
            
            loginPage.style.display = 'block';
            adminPanel.style.display = 'none';
            mainPage.style.display = 'none';
            passwordInput.value = '';
            loginError.style.display = 'none';
            currentUserRole = null;
            currentStore = null;
        }

        // è¼‰å…¥ç•¶å‰åº—å®¶è¨­å®š
        async function loadCurrentStore() {
            try {
                statusIndicator.textContent = 'è¼‰å…¥åº—å®¶è³‡è¨Šä¸­...';
                statusIndicator.className = 'status-indicator status-loading';
                
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
                const { getFirestore, collection, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // å˜—è©¦è®€å–åº—å®¶è¨­å®š
                try {
                    const storeConfigDoc = await getDoc(doc(db, 'config', 'currentStore'));
                    
                    if (storeConfigDoc.exists()) {
                        currentStore = storeConfigDoc.data().store;
                        showMainPage();
                    } else {
                        // å¦‚æœæ²’æœ‰è¨­å®šï¼Œé è¨­ä½¿ç”¨å°æ¾„å¸‚
                        console.log('æ²’æœ‰æ‰¾åˆ°åº—å®¶è¨­å®šï¼Œä½¿ç”¨é è¨­åº—å®¶');
                        currentStore = 'å°æ¾„å¸‚';
                        showMainPage();
                    }
                } catch (permissionError) {
                    // å¦‚æœæ¬Šé™ä¸è¶³ï¼Œä½¿ç”¨é è¨­åº—å®¶
                    console.log('ç„¡æ³•è®€å–åº—å®¶è¨­å®šï¼Œä½¿ç”¨é è¨­åº—å®¶:', permissionError);
                    currentStore = 'å°æ¾„å¸‚';
                    showMainPage();
                }
                
            } catch (error) {
                console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
                // å³ä½¿ Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œä¹Ÿä½¿ç”¨é è¨­åº—å®¶
                currentStore = 'å°æ¾„å¸‚';
                showMainPage();
            }
        }

        // è¼‰å…¥åº—å®¶é¸æ“‡ç‹€æ…‹
        async function loadStoreSelection() {
            try {
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
                const { getFirestore, collection, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                try {
                    const storeConfigDoc = await getDoc(doc(db, 'config', 'currentStore'));
                    
                    if (storeConfigDoc.exists()) {
                        const currentStoreValue = storeConfigDoc.data().store;
                        const radioButton = document.querySelector(`input[name="selectedStore"][value="${currentStoreValue}"]`);
                        if (radioButton) {
                            radioButton.checked = true;
                        }
                    }
                } catch (permissionError) {
                    console.log('ç„¡æ³•è®€å–åº—å®¶é¸æ“‡ç‹€æ…‹:', permissionError);
                    // é è¨­é¸æ“‡å°æ¾„å¸‚
                    const defaultRadio = document.querySelector('input[name="selectedStore"][value="å°æ¾„å¸‚"]');
                    if (defaultRadio) {
                        defaultRadio.checked = true;
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥åº—å®¶é¸æ“‡å¤±æ•—:', error);
                // é è¨­é¸æ“‡å°æ¾„å¸‚
                const defaultRadio = document.querySelector('input[name="selectedStore"][value="å°æ¾„å¸‚"]');
                if (defaultRadio) {
                    defaultRadio.checked = true;
                }
            }
        }

        // ç¢ºèªåº—å®¶é¸æ“‡
        async function confirmStoreSelection() {
            const selectedStore = document.querySelector('input[name="selectedStore"]:checked');
            
            if (!selectedStore) {
                alert('è«‹é¸æ“‡ä¸€é–“åº—å®¶');
                return;
            }
            
            try {
                confirmStoreBtn.disabled = true;
                confirmStoreBtn.textContent = 'è¨­å®šä¸­...';
                
                const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                
                try {
                    await setDoc(doc(db, 'config', 'currentStore'), {
                        store: selectedStore.value,
                        updatedAt: new Date(),
                        updatedBy: 'admin'
                    });
                    
                    currentStore = selectedStore.value;
                    showMainPage();
                } catch (permissionError) {
                    console.log('ç„¡æ³•å¯«å…¥åº—å®¶è¨­å®šï¼Œä½¿ç”¨æœ¬åœ°è¨­å®š:', permissionError);
                    // å³ä½¿ç„¡æ³•å¯«å…¥ Firebaseï¼Œä¹Ÿå…è¨±æœ¬åœ°ä½¿ç”¨é¸å®šçš„åº—å®¶
                    currentStore = selectedStore.value;
                    showMainPage();
                    alert('åº—å®¶è¨­å®šå·²åœ¨æœ¬æ¬¡ä½¿ç”¨ä¸­ç”Ÿæ•ˆï¼ˆç„¡æ³•ä¿å­˜åˆ°é›²ç«¯ï¼‰');
                }
                
            } catch (error) {
                console.error('è¨­å®šåº—å®¶å¤±æ•—:', error);
                // å³ä½¿å¤±æ•—ä¹Ÿä½¿ç”¨é¸å®šçš„åº—å®¶
                currentStore = selectedStore.value;
                showMainPage();
                alert('åº—å®¶è¨­å®šå·²åœ¨æœ¬æ¬¡ä½¿ç”¨ä¸­ç”Ÿæ•ˆ');
            } finally {
                confirmStoreBtn.disabled = false;
                confirmStoreBtn.textContent = 'ç¢ºèªä¸¦é–‹å§‹ç‡Ÿæ¥­';
            }
        }

        // åˆå§‹åŒ–èœå–®
        function initializeMenu() {
            if (!currentStore || !storeMenus[currentStore]) {
                console.error('åº—å®¶è³‡æ–™ä¸å­˜åœ¨:', currentStore);
                return;
            }
            
            const storeData = storeMenus[currentStore];
            
            // æ›´æ–°åº—å®¶åç¨±é¡¯ç¤º
            currentStoreName.textContent = storeData.name;
            
            // æ›´æ–°åˆ†é¡é¸å–®
            categorySelect.innerHTML = '<option value="">è«‹é¸æ“‡åˆ†é¡</option>';
            Object.keys(storeData.categories).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            
            // æ›´æ–°åŠ æ–™é¸é …
            updateToppingsOptions(storeData.toppings);
        }

        // æ›´æ–°åŠ æ–™é¸é …
        function updateToppingsOptions(toppings) {
            toppingsGrid.innerHTML = '';
            
            toppings.forEach((topping, index) => {
                const toppingDiv = document.createElement('div');
                toppingDiv.className = 'topping-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `topping${index + 1}`;
                checkbox.value = topping.name;
                checkbox.dataset.price = topping.price;
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = `${topping.name} (+${topping.price})`;
                
                toppingDiv.appendChild(checkbox);
                toppingDiv.appendChild(label);
                toppingsGrid.appendChild(toppingDiv);
            });
        }

        // å°æ¾„å¸‚ç‰¹æ®Šè¦å‰‡æª¢æŸ¥å‡½æ•¸
        function isSaltSnowSeries(category) {
            return currentStore === 'å°æ¾„å¸‚' && category === 'å¡©é›ªæ¾„å¸‚';
        }

        function isAppleAuLait(item) {
            return currentStore === 'å°æ¾„å¸‚' && item === 'é®®æ¦¨è˜‹æœæ­è•¾';
        }

        function isSeasonalLimited(category) {
            return currentStore === 'å°æ¾„å¸‚' && category === 'å­£ç¯€é™å®š';
        }

        function isMangoGreenTea(item) {
            return currentStore === 'å°æ¾„å¸‚' && item === 'ä¸‰çª¨èŠ’æœç¶ èŒ¶';
        }

        function isMangoBaozhongTea(item) {
            return currentStore === 'å°æ¾„å¸‚' && item === 'å››å­£èŠ’æœé’èŒ¶';
        }

        function isIcecreamBlackTea(item) {
            return currentStore === 'å°æ¾„å¸‚' && item === 'å†°æ·‡æ·‹ç´…èŒ¶';
        }

        function isMangoSeries(item) {
            return currentStore === 'å°æ¾„å¸‚' && (item === 'ä¸‰çª¨èŠ’æœç¶ èŒ¶' || item === 'å››å­£èŠ’æœé’èŒ¶');
        }

        function isSmoothie(item) {
            return currentStore === 'å°æ¾„å¸‚' && ['ç¿¡ç¿ å‡æª¸æª¬', 'æ¡ƒæ°£æª¸æª¬', 'é‡‘é‘½èœœé³³æ¢¨', 'æ¾„å¸‚æ°´æœèŒ¶'].includes(item);
        }

        // æ›´æ–°å†°å¡Šé¸é …
        function updateIceOptions(category, item = null) {
            iceSelect.innerHTML = '';
            
            if (currentStore === 'å°æ¾„å¸‚') {
                // å°æ¾„å¸‚çš„ç‰¹æ®Šè¦å‰‡
                if (isSaltSnowSeries(category)) {
                    const saltSnowIceOptions = [
                        { value: 'æ­£å¸¸å†°', text: 'æ­£å¸¸å†°' },
                        { value: 'å°‘å†°', text: 'å°‘å†°' },
                        { value: 'å¾®å†°', text: 'å¾®å†°' }
                    ];
                    
                    saltSnowIceOptions.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        iceSelect.appendChild(optionElement);
                    });
                } else if (item && isMangoSeries(item)) {
                    const mangoIceOptions = [
                        { value: 'æ­£å¸¸å†°', text: 'æ­£å¸¸å†°' },
                        { value: 'å°‘å†°', text: 'å°‘å†°' },
                        { value: 'å¾®å†°', text: 'å¾®å†°' },
                        { value: 'å»å†°', text: 'å»å†°' }
                    ];
                    
                    mangoIceOptions.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        iceSelect.appendChild(optionElement);
                    });
                } else if (item && isIcecreamBlackTea(item)) {
                    const icecreamBlackTeaIceOptions = [
                        { value: 'æ­£å¸¸å†°', text: 'æ­£å¸¸å†°' },
                        { value: 'å°‘å†°', text: 'å°‘å†°' },
                        { value: 'å¾®å†°', text: 'å¾®å†°' },
                        { value: 'å»å†°', text: 'å»å†°' }
                    ];
                    
                    icecreamBlackTeaIceOptions.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        iceSelect.appendChild(optionElement);
                    });
                } else if (item && isSmoothie(item)) {
                    const smoothieIceOptions = [
                        { value: 'æ­£å¸¸å†°', text: 'æ­£å¸¸å†°' },
                        { value: 'å°‘å†°', text: 'å°‘å†°' },
                        { value: 'å¾®å†°', text: 'å¾®å†°' },
                        { value: 'å»å†°', text: 'å»å†°' },
                        { value: 'å†°æ²™', text: 'å†°æ²™' }
                    ];
                    
                    smoothieIceOptions.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        iceSelect.appendChild(optionElement);
                    });
                } else {
                    // å°æ¾„å¸‚çš„æ­£å¸¸é¸é …
                    const normalIceOptions = [
                        { value: 'æ­£å¸¸å†°', text: 'æ­£å¸¸å†°' },
                        { value: 'å°‘å†°', text: 'å°‘å†°' },
                        { value: 'å¾®å†°', text: 'å¾®å†°' },
                        { value: 'å»å†°', text: 'å»å†°' },
                        { value: 'å®Œå…¨å»å†°', text: 'å®Œå…¨å»å†°' },
                        { value: 'æº«é£²', text: 'æº«é£²' },
                        { value: 'ç†±é£²', text: 'ç†±é£²' }
                    ];
                    
                    normalIceOptions.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        iceSelect.appendChild(optionElement);
                    });
                }
            } else {
                // å…¶ä»–åº—å®¶ï¼ˆå¦‚50åµï¼‰çš„æ¨™æº–å†°å¡Šé¸é …
                const standardIceOptions = [
                    { value: 'æ­£å¸¸å†°', text: 'æ­£å¸¸å†°' },
                    { value: 'å°‘å†°', text: 'å°‘å†°' },
                    { value: 'å¾®å†°', text: 'å¾®å†°' },
                    { value: 'å»å†°', text: 'å»å†°' },
                    { value: 'æº«é£²', text: 'æº«é£²' },
                    { value: 'ç†±é£²', text: 'ç†±é£²' }
                ];
                
                standardIceOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    iceSelect.appendChild(optionElement);
                });
            }
            
            iceSelect.value = 'æ­£å¸¸å†°';
        }

        // æ›´æ–°ç”œåº¦é¸é …
        function updateSweetnessOptions(item = null) {
            sweetnessSelect.innerHTML = '';
            
            if (currentStore === 'å°æ¾„å¸‚' && item && isMangoSeries(item)) {
                // å°æ¾„å¸‚èŠ’æœç³»åˆ—ï¼šæœ€å°‘å¾®ç³–
                const mangoSweetnessOptions = [
                    { value: 'æ­£å¸¸ç”œ', text: 'æ­£å¸¸ç”œ' },
                    { value: 'å°‘ç³–', text: 'å°‘ç³–' },
                    { value: 'åŠç³–', text: 'åŠç³–' },
                    { value: 'å¾®ç³–', text: 'å¾®ç³–' },
                    { value: '1åˆ†ç³–', text: '1åˆ†ç³–' }
                ];
                
                mangoSweetnessOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    sweetnessSelect.appendChild(optionElement);
                });
            } else {
                // æ¨™æº–ç”œåº¦é¸é …
                const normalSweetnessOptions = [
                    { value: 'æ­£å¸¸ç”œ', text: 'æ­£å¸¸ç”œ' },
                    { value: 'å°‘ç³–', text: 'å°‘ç³–' },
                    { value: 'åŠç³–', text: 'åŠç³–' },
                    { value: 'å¾®ç³–', text: 'å¾®ç³–' },
                    { value: '1åˆ†ç³–', text: '1åˆ†ç³–' },
                    { value: 'ç„¡ç³–', text: 'ç„¡ç³–' }
                ];
                
                normalSweetnessOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    sweetnessSelect.appendChild(optionElement);
                });
            }
            
            sweetnessSelect.value = 'æ­£å¸¸ç”œ';
        }

        // æ›´æ–°é¸é …ç‹€æ…‹
        function updateOptionsForItem(item, category) {
            updateSweetnessOptions(item);
            updateIceOptions(category, item);
            
            if (currentStore === 'å°æ¾„å¸‚') {
                // å°æ¾„å¸‚çš„ç‰¹æ®Šè¦å‰‡
                if (isAppleAuLait(item)) {
                    sweetnessSelect.disabled = true;
                    iceSelect.disabled = true;
                    sweetnessSelect.value = 'æ­£å¸¸ç”œ';
                    iceSelect.value = 'æ­£å¸¸å†°';
                    
                    specialNotice.style.display = 'block';
                    noticeText.textContent = 'è˜‹æœæ­è•¾çš„ç”œåº¦å’Œå†°å¡Šå·²å›ºå®šï¼Œç„¡æ³•èª¿æ•´ã€‚';
                } else if (isSeasonalLimited(category) && (!isMangoGreenTea(item) && !isMangoBaozhongTea(item))) {
                    sweetnessSelect.disabled = true;
                    iceSelect.disabled = true;
                    sweetnessSelect.value = 'æ­£å¸¸ç”œ';
                    iceSelect.value = 'æ­£å¸¸å†°';
                    
                    specialNotice.style.display = 'block';
                    noticeText.textContent = 'æ­¤å­£ç¯€é™å®šé£²å“çš„ç”œåº¦å’Œå†°å¡Šå·²å›ºå®šï¼Œç„¡æ³•èª¿æ•´ã€‚';
                } else {
                    sweetnessSelect.disabled = false;
                    iceSelect.disabled = false;
                    
                    let noticeMessages = [];
                    
                    if (isSaltSnowSeries(category)) {
                        noticeMessages.push('å¡©é›ªç³»åˆ—æœ€ä½å†°é‡ç‚ºå¾®å†°ï¼Œç„¡æ³•é¸æ“‡å»å†°ã€æº«é£²æˆ–ç†±é£²');
                    }
                    
                    if (isMangoSeries(item)) {
                        noticeMessages.push('èŠ’æœç³»åˆ—æœ€ä½ç”œåº¦ç‚º1åˆ†ç³–ï¼Œç„¡æ³•é¸æ“‡ç„¡ç³–');
                        noticeMessages.push('èŠ’æœç³»åˆ—ç„¡æ³•é¸æ“‡æº«é£²æˆ–ç†±é£²');
                    }

                    if (isIcecreamBlackTea(item)) {
                        noticeMessages.push('å†°æ·‡æ·‹ç´…èŒ¶ç„¡æ³•é¸æ“‡æº«é£²æˆ–ç†±é£²');
                    }
                    
                    if (noticeMessages.length > 0) {
                        specialNotice.style.display = 'block';
                        noticeText.textContent = noticeMessages.join('ï¼›') + 'ã€‚';
                    } else {
                        specialNotice.style.display = 'none';
                    }
                }
            } else {
                // å…¶ä»–åº—å®¶æ²’æœ‰ç‰¹æ®Šé™åˆ¶
                sweetnessSelect.disabled = false;
                iceSelect.disabled = false;
                specialNotice.style.display = 'none';
            }
        }

        // åˆå§‹åŒ– Firebase
        async function initializeFirebase() {
            try {
                statusIndicator.textContent = 'é€£æ¥ä¸­...';
                statusIndicator.className = 'status-indicator status-loading';
                
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
                const { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, getDocs } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                
                window.firebaseFunctions = { addDoc, deleteDoc, doc, getDocs };
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                ordersRef = collection(db, 'orders');
                
                // ç›£è½ç•¶å‰åº—å®¶è®Šæ›´ï¼ˆå¦‚æœæœ‰æ¬Šé™çš„è©±ï¼‰
                try {
                    storeUnsubscribe = onSnapshot(doc(db, 'config', 'currentStore'), (doc) => {
                        if (doc.exists()) {
                            const newStore = doc.data().store;
                            if (newStore !== currentStore) {
                                currentStore = newStore;
                                initializeMenu();
                                resetForm();
                            }
                        }
                    });
                } catch (permissionError) {
                    console.log('ç„¡æ³•ç›£è½åº—å®¶è®Šæ›´ï¼Œä½¿ç”¨ç•¶å‰è¨­å®š:', permissionError);
                }
                
                const q = query(ordersRef, orderBy('timestamp', 'desc'));
                unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const orders = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (!data.test && data.store === currentStore) {
                            orders.push({
                                id: doc.id,
                                ...data
                            });
                        }
                    });
                    updateOrderTable(orders);
                    updateSummary(orders);
                    lastUpdateSpan.textContent = new Date().toLocaleTimeString();
                });
                
                statusIndicator.textContent = 'å·²é€£æ¥';
                statusIndicator.className = 'status-indicator status-connected';
                
                initializeMenu();
                setupEventListeners();
                
                // æ ¹æ“šä½¿ç”¨è€…è§’è‰²é¡¯ç¤º/éš±è—ç®¡ç†åŠŸèƒ½
                updateUIForUserRole();
                
            } catch (error) {
                console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
                statusIndicator.textContent = 'é€£æ¥å¤±æ•—';
                statusIndicator.className = 'status-indicator status-disconnected';
            }
        }

        // æ ¹æ“šä½¿ç”¨è€…è§’è‰²æ›´æ–°UI
        function updateUIForUserRole() {
            const adminControls = document.getElementById('adminControls');
            const adminSwitchBtn = document.getElementById('adminSwitchBtn');
            
            if (currentUserRole === 'admin') {
                // ç®¡ç†å“¡ï¼šé¡¯ç¤ºæ‰€æœ‰ç®¡ç†åŠŸèƒ½
                adminControls.style.display = 'block';
                adminSwitchBtn.style.display = 'block';
            } else {
                // ä¸€èˆ¬ä½¿ç”¨è€…ï¼šéš±è—ç®¡ç†åŠŸèƒ½
                adminControls.style.display = 'none';
                adminSwitchBtn.style.display = 'none';
            }
        }

        // é‡ç½®è¡¨å–®
        function resetForm() {
            categorySelect.value = '';
            itemSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡åˆ†é¡</option>';
            itemSelect.disabled = true;
            customerNameInput.value = '';
            customerNameInput.disabled = true;
            optionsGroup.style.display = 'none';
            quantityInput.value = 1;
            quantityInput.disabled = true;
            addBtn.disabled = true;
            specialNotice.style.display = 'none';
            
            // é‡ç½®åŠ æ–™é¸é …
            const toppingInputs = document.querySelectorAll('#toppingsGrid input[type="checkbox"]');
            toppingInputs.forEach(input => input.checked = false);
        }

        // æ–°å¢è¨‚å–®
        async function addOrder() {
            if (!db || !window.firebaseFunctions) {
                alert('è«‹ç¨å€™ï¼Œç³»çµ±æ­£åœ¨é€£æ¥ä¸­...');
                return;
            }
            
            const category = categorySelect.value;
            const item = itemSelect.value;
            const customerName = customerNameInput.value.trim();
            const quantity = parseInt(quantityInput.value);
            const basePrice = parseInt(itemSelect.selectedOptions[0].dataset.price);
            const sweetness = sweetnessSelect.value;
            const ice = iceSelect.value;
            
            if (!customerName) {
                alert('è«‹å¡«å…¥é¡§å®¢å§“åï¼');
                customerNameInput.focus();
                return;
            }
            
            const toppings = [];
            let toppingPrice = 0;
            const toppingInputs = document.querySelectorAll('#toppingsGrid input[type="checkbox"]:checked');
            toppingInputs.forEach(input => {
                toppings.push(input.value);
                toppingPrice += parseInt(input.dataset.price);
            });
            
            const totalPrice = basePrice + toppingPrice;
            const toppingsText = toppings.length > 0 ? toppings.join(', ') : 'ç„¡';

            if (category && item && quantity > 0) {
                try {
                    addBtn.disabled = true;
                    addBtn.textContent = 'æ–°å¢ä¸­...';
                    
                    const orderData = {
                        store: currentStore,
                        customerName: customerName,
                        category: category,
                        item: item,
                        sweetness: sweetness,
                        ice: ice,
                        toppings: toppingsText,
                        basePrice: basePrice,
                        toppingPrice: toppingPrice,
                        totalPrice: totalPrice,
                        quantity: quantity,
                        subtotal: totalPrice * quantity,
                        timestamp: new Date()
                    };
                    
                    await window.firebaseFunctions.addDoc(ordersRef, orderData);
                    
                    customerNameInput.value = '';
                    quantityInput.value = 1;
                    sweetnessSelect.value = 'æ­£å¸¸ç”œ';
                    iceSelect.value = 'æ­£å¸¸å†°';
                    toppingInputs.forEach(input => input.checked = false);
                    
                } catch (error) {
                    console.error('æ–°å¢è¨‚å–®å¤±æ•—:', error);
                    alert('æ–°å¢è¨‚å–®å¤±æ•—ï¼Œè«‹é‡è©¦');
                } finally {
                    addBtn.disabled = false;
                    addBtn.textContent = 'æ–°å¢åˆ°è¨‚å–®';
                }
            }
        }

        // åˆªé™¤è¨‚å–®ï¼ˆåƒ…ç®¡ç†å“¡ï¼‰
        async function removeOrder(orderId) {
            if (currentUserRole !== 'admin') {
                alert('æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨');
                return;
            }
            
            if (!db || !window.firebaseFunctions) return;
            
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ')) {
                try {
                    await window.firebaseFunctions.deleteDoc(window.firebaseFunctions.doc(db, 'orders', orderId));
                } catch (error) {
                    console.error('åˆªé™¤è¨‚å–®å¤±æ•—:', error);
                    alert('åˆªé™¤è¨‚å–®å¤±æ•—ï¼Œè«‹é‡è©¦');
                }
            }
        }

        // æ¸…ç©ºæ‰€æœ‰è¨‚å–®ï¼ˆåƒ…ç®¡ç†å“¡ï¼‰
        async function clearAllOrders() {
            if (currentUserRole !== 'admin') {
                alert('æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨');
                return;
            }
            
            if (!db || !window.firebaseFunctions) return;
            
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\nâš ï¸ æ­¤æ“ä½œåƒ…é™ç®¡ç†å“¡åŸ·è¡Œ')) {
                try {
                    const snapshot = await window.firebaseFunctions.getDocs(ordersRef);
                    const deletePromises = [];
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (!data.test && data.store === currentStore) {
                            deletePromises.push(window.firebaseFunctions.deleteDoc(doc.ref));
                        }
                    });
                    
                    await Promise.all(deletePromises);
                    alert('æ‰€æœ‰è¨‚å–®å·²æ¸…ç©º');
                } catch (error) {
                    console.error('æ¸…ç©ºè¨‚å–®å¤±æ•—:', error);
                    alert('æ¸…ç©ºè¨‚å–®å¤±æ•—ï¼Œè«‹é‡è©¦');
                }
            }
        }

        // æ›´æ–°è¨‚å–®è¡¨æ ¼
        function updateOrderTable(orders) {
            if (orders.length === 0) {
                orderTableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">ç›®å‰æ²’æœ‰è¨‚å–®</td></tr>';
                return;
            }

            let html = '';
            orders.forEach((order, index) => {
                const priceDetail = order.toppingPrice > 0 ? 
                    `NT$ ${order.basePrice} + ${order.toppingPrice}` : 
                    `NT$ ${order.basePrice}`;
                
                const orderTime = order.timestamp ? 
                    new Date(order.timestamp.seconds * 1000).toLocaleTimeString() : 
                    'æœªçŸ¥';
                
                html += `
                    <tr>
                        <td>${orderTime}</td>
                        <td>${order.customerName}</td>
                        <td>${order.category}</td>
                        <td>${order.item}</td>
                        <td>${order.sweetness}</td>
                        <td>${order.ice}</td>
                        <td>${order.toppings}</td>
                        <td>${priceDetail}</td>
                        <td>${order.quantity}</td>
                        <td>NT$ ${order.subtotal}</td>
                        <td>
                            ${currentUserRole === 'admin' ? 
                                `<button class="remove-btn" data-order-id="${order.id}">åˆªé™¤</button>` : 
                                '-'
                            }
                        </td>
                    </tr>
                `;
            });

            const totalAmount = orders.reduce((sum, order) => sum + order.subtotal, 0);
            const totalQuantity = orders.reduce((sum, order) => sum + order.quantity, 0);
            
            html += `
                <tr class="total-row">
                    <td colspan="8">ç¸½è¨ˆ</td>
                    <td>${totalQuantity}</td>
                    <td>NT$ ${totalAmount}</td>
                    <td>-</td>
                </tr>
            `;

            orderTableBody.innerHTML = html;
            
            const removeButtons = orderTableBody.querySelectorAll('.remove-btn');
            removeButtons.forEach(button => {
                if (button.dataset.orderId) {
                    button.addEventListener('click', () => removeOrder(button.dataset.orderId));
                }
            });
        }

        // æ›´æ–°çµ±è¨ˆæ‘˜è¦
        function updateSummary(orders) {
            const totalItems = orders.length;
            const totalQuantity = orders.reduce((sum, order) => sum + order.quantity, 0);
            const totalAmount = orders.reduce((sum, order) => sum + order.subtotal, 0);
            const uniqueCustomers = new Set(orders.map(order => order.customerName)).size;

            document.getElementById('uniqueCustomers').textContent = uniqueCustomers;
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalQuantity').textContent = totalQuantity;
            document.getElementById('totalAmount').textContent = `NT$ ${totalAmount}`;
        }

        // åŒ¯å‡º CSV
        function exportToCSV() {
            const table = document.getElementById('orderTable');
            const rows = table.querySelectorAll('tbody tr');
            
            if (rows.length <= 1) {
                alert('æ²’æœ‰è¨‚å–®è³‡æ–™å¯ä»¥åŒ¯å‡º');
                return;
            }

            let csv = `åº—å®¶,æ™‚é–“,é¡§å®¢å§“å,åˆ†é¡,å“é …,ç”œåº¦,å†°å¡Š,åŠ æ–™,åŸºæœ¬åƒ¹æ ¼,åŠ æ–™åƒ¹æ ¼,ç¸½å–®åƒ¹,æ•¸é‡,å°è¨ˆ\n`;
            
            for (let i = 0; i < rows.length - 1; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td');
                
                if (cells.length >= 10) {
                    const time = cells[0].textContent.trim();
                    const customerName = cells[1].textContent.trim();
                    const category = cells[2].textContent.trim();
                    const item = cells[3].textContent.trim();
                    const sweetness = cells[4].textContent.trim();
                    const ice = cells[5].textContent.trim();
                    const toppings = cells[6].textContent.trim();
                    const priceText = cells[7].textContent.trim();
                    const quantity = cells[8].textContent.trim();
                    const subtotal = cells[9].textContent.replace('NT$ ', '').trim();
                    
                    let basePrice = '';
                    let toppingPrice = '0';
                    let totalPrice = '';
                    
                    if (priceText.includes(' + ')) {
                        const prices = priceText.split(' + ');
                        basePrice = prices[0].replace('NT$ ', '');
                        toppingPrice = prices[1];
                        totalPrice = (parseInt(basePrice) + parseInt(toppingPrice)).toString();
                    } else {
                        basePrice = priceText.replace('NT$ ', '');
                        totalPrice = basePrice;
                    }
                    
                    csv += `"${currentStore}","${time}","${customerName}","${category}","${item}","${sweetness}","${ice}","${toppings}",${basePrice},${toppingPrice},${totalPrice},${quantity},${subtotal}\n`;
                }
            }

            const totalRow = rows[rows.length - 1];
            if (totalRow && totalRow.classList.contains('total-row')) {
                const totalCells = totalRow.querySelectorAll('td');
                if (totalCells.length >= 3) {
                    const totalQuantity = totalCells[totalCells.length - 2].textContent.trim();
                    const totalAmount = totalCells[totalCells.length - 1].textContent.replace('NT$ ', '').trim();
                    csv += `"${currentStore}",ç¸½è¨ˆ,,,,,,,,,${totalQuantity},${totalAmount}\n`;
                }
            }

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${currentStore}_è¨‚å–®_${new Date().toISOString().slice(0, 10)}.csv`);
            link.click();
        }

        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            categorySelect.addEventListener('change', function() {
                const category = this.value;
                itemSelect.innerHTML = '<option value="">è«‹é¸æ“‡å“é …</option>';
                
                if (category && currentStore && storeMenus[currentStore] && storeMenus[currentStore].categories[category]) {
                    updateIceOptions(category);
                    updateSweetnessOptions();
                    
                    Object.keys(storeMenus[currentStore].categories[category]).forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;
                        option.textContent = `${item} - NT$ ${storeMenus[currentStore].categories[category][item]}`;
                        option.dataset.price = storeMenus[currentStore].categories[category][item];
                        itemSelect.appendChild(option);
                    });
                    itemSelect.disabled = false;
                    customerNameInput.disabled = false;
                } else {
                    itemSelect.disabled = true;
                    customerNameInput.disabled = true;
                    optionsGroup.style.display = 'none';
                    quantityInput.disabled = true;
                    addBtn.disabled = true;
                    specialNotice.style.display = 'none';
                }
            });

            itemSelect.addEventListener('change', function() {
                const item = this.value;
                const category = categorySelect.value;
                
                if (item) {
                    optionsGroup.style.display = 'block';
                    quantityInput.disabled = false;
                    addBtn.disabled = false;
                    
                    updateOptionsForItem(item, category);
                } else {
                    optionsGroup.style.display = 'none';
                    quantityInput.disabled = true;
                    addBtn.disabled = true;
                    specialNotice.style.display = 'none';
                    
                    updateSweetnessOptions();
                }
            });

            addBtn.addEventListener('click', addOrder);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('clearBtn').addEventListener('click', clearAllOrders);
        }

        // é‡ç½®ç”œåº¦é¸é …ç‚ºé è¨­
        function resetSweetnessOptions() {
            updateSweetnessOptions(null);
        }

        // äº‹ä»¶ç›£è½å™¨è¨­å®š
        loginBtn.addEventListener('click', checkPassword);
        confirmStoreBtn.addEventListener('click', confirmStoreSelection);
        backToLoginBtn.addEventListener('click', () => {
            adminPanel.style.display = 'none';
            loginPage.style.display = 'block';
        });
        adminSwitchBtn.addEventListener('click', () => {
            if (currentUserRole === 'admin') {
                showAdminPanel();
            } else {
                alert('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™');
            }
        });
        logoutBtn.addEventListener('click', logout);
        
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        window.addEventListener('load', function() {
            const authData = localStorage.getItem('teaOrderAuth');
            if (authData) {
                try {
                    const parsed = JSON.parse(authData);
                    const now = Date.now();
                    const loginTime = parsed.timestamp;
                    
                    // æª¢æŸ¥ç™»å…¥æ˜¯å¦åœ¨24å°æ™‚å…§
                    if (now - loginTime < 24 * 60 * 60 * 1000) {
                        currentUserRole = parsed.role;
                        
                        if (parsed.role === 'admin') {
                            // ç®¡ç†å“¡å¯ä»¥é¸æ“‡é€²å…¥ç®¡ç†é¢æ¿æˆ–ç›´æ¥é€²å…¥ç³»çµ±
                            showAdminPanel();
                        } else {
                            loadCurrentStore();
                        }
                    } else {
                        // ç™»å…¥éæœŸ
                        localStorage.removeItem('teaOrderAuth');
                        passwordInput.focus();
                    }
                } catch (error) {
                    localStorage.removeItem('teaOrderAuth');
                    passwordInput.focus();
                }
            } else {
                passwordInput.focus();
            }
        });

        // é é¢é—œé–‰æ™‚æ¸…ç†ç›£è½å™¨
        window.addEventListener('beforeunload', function() {
            if (unsubscribe) unsubscribe();
            if (storeUnsubscribe) storeUnsubscribe();
        });

        // å…¨åŸŸå‡½æ•¸
        window.removeOrder = removeOrder;
    </script>
</body>
</html>