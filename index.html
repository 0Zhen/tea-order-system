<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧋 多店家茶飲訂購系統</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 40px;
            text-align: center;
        }
        
        .login-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
        }
        
        .error-message {
            color: #dc3545;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .role-selector {
            margin-bottom: 20px;
        }
        
        .role-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }
        
        .role-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }
        
        .admin-panel {
            max-width: 600px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 40px;
            display: none;
        }
        
        .admin-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .store-selection {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .store-selection h3 {
            margin: 0 0 15px 0;
            color: #2d5a2d;
        }
        
        .store-option {
            margin-bottom: 10px;
        }
        
        .store-option input[type="radio"] {
            margin-right: 10px;
        }
        
        .store-option label {
            font-size: 16px;
            cursor: pointer;
        }
        
        .admin-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .admin-buttons button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .store-name {
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .admin-switch {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .admin-switch:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .status-indicator {
            position: absolute;
            top: 70px;
            left: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-connected {
            background: #28a745;
            color: white;
        }
        
        .status-disconnected {
            background: #dc3545;
            color: white;
        }
        
        .status-loading {
            background: #ffc107;
            color: #333;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .options-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .option-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .option-section label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .toppings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 5px;
        }
        
        .topping-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        
        .topping-item input[type="checkbox"] {
            margin: 0;
        }
        
        .control-group label {
            font-weight: bold;
            min-width: 80px;
        }
        
        select, input, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        select {
            min-width: 200px;
        }
        
        input[type="number"] {
            width: 80px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .admin-controls {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .admin-controls-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2d5a2d;
        }
        
        .table-container {
            overflow-x: auto;
            padding: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        tr:hover {
            background: #e9ecef;
        }
        
        .total-row {
            background: #e3f2fd !important;
            font-weight: bold;
        }
        
        .summary {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .summary h3 {
            margin: 0 0 10px 0;
            color: #2d5a2d;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        .notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
            color: #856404;
        }
        
        @media (max-width: 768px) {
            .login-container, .admin-panel {
                margin: 20px auto;
                padding: 30px 20px;
            }
            
            .container {
                margin: 10px;
                border-radius: 0;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group label {
                min-width: auto;
            }
            
            select, input {
                min-width: auto;
                width: 100%;
            }
            
            .admin-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- 登入頁面 -->
    <div id="loginPage" class="login-container">
        <div class="login-title">🧋 多店家茶飲訂購系統</div>
        <div class="login-subtitle">請選擇身份並輸入密碼</div>
        
        <div class="role-selector">
            <label>選擇身份：</label>
            <select id="roleSelect">
                <option value="user">一般使用者</option>
                <option value="admin">管理員</option>
            </select>
        </div>
        
        <input type="password" id="passwordInput" class="password-input" placeholder="請輸入密碼" />
        <button id="loginBtn" class="login-btn">登入</button>
        <div id="loginError" class="error-message" style="display: none;"></div>
    </div>

    <!-- 管理員面板 -->
    <div id="adminPanel" class="admin-panel">
        <div class="admin-title">🔧 管理員控制面板</div>
        
        <div class="store-selection">
            <h3>選擇今日營業店家：</h3>
            <div class="store-option">
                <input type="radio" id="store1" name="selectedStore" value="小澄市">
                <label for="store1">🧋 小澄市</label>
            </div>
            <div class="store-option">
                <input type="radio" id="store2" name="selectedStore" value="50嵐">
                <label for="store2">🧋 50嵐</label>
            </div>
            <div class="store-option">
                <input type="radio" id="store2" name="selectedStore" value="南海茶道">
                <label for="store2">🧋 南海茶道</label>
            </div>
        </div>
        
        <div class="admin-buttons">
            <button id="confirmStoreBtn" class="btn-primary">確認並開始營業</button>
            <button id="backToLoginBtn" class="btn-secondary">返回登入</button>
        </div>
    </div>

    <!-- 主要系統頁面 -->
    <div id="mainPage" class="container">
        <div class="header">
            <h1>🧋 多店家茶飲訂購系統</h1>
            <div id="currentStoreName" class="store-name">載入中...</div>
            <p>即時同步，多人協作點餐</p>
            <button id="adminSwitchBtn" class="admin-switch">管理員模式</button>
            <button id="logoutBtn" class="logout-btn">登出</button>
            <div id="statusIndicator" class="status-indicator status-loading">連接中...</div>
        </div>
        
        <!-- 管理者控制面板 -->
        <div class="admin-controls" id="adminControls" style="display: none;">
            <div class="admin-controls-title">📊 管理者控制面板</div>
            <div class="control-group">
                <button id="exportBtn" class="btn-success">匯出所有訂單 CSV</button>
                <button id="clearBtn" class="btn-danger">清空所有訂單</button>
                <span style="margin-left: 20px; font-weight: bold;">即時更新：<span id="lastUpdate">-</span></span>
            </div>
        </div>
        
        <!-- 點餐表單 -->
        <div class="controls">
            <div class="control-group">
                <label>選擇分類：</label>
                <select id="categorySelect">
                    <option value="">請選擇分類</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>選擇品項：</label>
                <select id="itemSelect" disabled>
                    <option value="">請先選擇分類</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>顧客姓名：</label>
                <input type="text" id="customerName" placeholder="請輸入顧客姓名" disabled style="min-width: 150px;">
            </div>
            
            <div class="options-group" id="optionsGroup" style="display: none;">
                <div class="option-section">
                    <label>甜度：</label>
                    <select id="sweetnessSelect">
                        <option value="正常甜">正常甜</option>
                        <option value="少糖">少糖</option>
                        <option value="半糖">半糖</option>
                        <option value="微糖">微糖</option>
                        <option value="1分糖">1分糖</option>
                        <option value="無糖">無糖</option>
                    </select>
                </div>
                
                <div class="option-section">
                    <label>冰塊：</label>
                    <select id="iceSelect">
                        <option value="正常冰">正常冰</option>
                        <option value="少冰">少冰</option>
                        <option value="微冰">微冰</option>
                        <option value="去冰">去冰</option>
                        <option value="完全去冰">完全去冰</option>
                        <option value="溫飲">溫飲</option>
                        <option value="熱飲">熱飲</option>
                    </select>
                </div>
                
                <div class="option-section">
                    <label>加料：</label>
                    <div class="toppings-grid" id="toppingsGrid">
                        <!-- 加料選項會根據店家動態生成 -->
                    </div>
                </div>
                
                <div id="specialNotice" class="notice" style="display: none;">
                    <strong>特別說明：</strong>
                    <span id="noticeText"></span>
                </div>
            </div>
            
            <div class="control-group">
                <label>數量：</label>
                <input type="number" id="quantity" min="1" value="1" disabled>
                <button id="addBtn" disabled>新增到訂單</button>
            </div>
        </div>
        
        <!-- 即時訂單表格 -->
        <div class="table-container">
            <table id="orderTable">
                <thead>
                    <tr>
                        <th>時間</th>
                        <th>顧客姓名</th>
                        <th>分類</th>
                        <th>品項</th>
                        <th>甜度</th>
                        <th>冰塊</th>
                        <th>加料</th>
                        <th>單價</th>
                        <th>數量</th>
                        <th>小計</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    <tr>
                        <td colspan="11" style="text-align: center; color: #666;">載入中...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 統計摘要 -->
        <div class="summary">
            <h3>📊 即時統計</h3>
            <div class="summary-item">
                <span>不同顧客數：</span>
                <span id="uniqueCustomers">0</span>
            </div>
            <div class="summary-item">
                <span>總品項數：</span>
                <span id="totalItems">0</span>
            </div>
            <div class="summary-item">
                <span>總數量：</span>
                <span id="totalQuantity">0</span>
            </div>
            <div class="summary-item">
                <span>總金額：</span>
                <span id="totalAmount">NT$ 0</span>
            </div>
        </div>
    </div>

    <script type="module">
        // 密碼設定
        const PASSWORDS = {
            user: 'hy123',
            admin: 'admin123'
        };
        
        // Firebase 設定
        const firebaseConfig = {
            "apiKey": "AIzaSyC6BlzAWm2PFBRJrtzySyI0spJrk-DIuvA",
            "authDomain": "order-collect-eb163.firebaseapp.com",
            "projectId": "order-collect-eb163",
            "storageBucket": "order-collect-eb163.firebasestorage.app",
            "messagingSenderId": "276173896243",
            "appId": "1:276173896243:web:e7cc9f400d4d509699c146",
            "measurementId": "G-2NCH0KCLRZ"
        };
        
        // 全域變數
        let db = null;
        let ordersRef = null;
        let storeConfigRef = null;
        let unsubscribe = null;
        let storeUnsubscribe = null;
        let currentUserRole = null;
        let currentStore = null;
        
        // 店家菜單資料
        const storeMenus = {
            "小澄市": {
                name: "🧋 小澄市",
                categories: {
                    "原沏小茶園": {
                        "復刻紅茶": 35,
                        "金萱蜜香紅茶": 35,
                        "黃金穀蕎麥": 40,
                        "四季春青茶": 35,
                        "三窨茉莉綠茶": 35
                    },
                    "澄市小牧場": {
                        "金萱鮮奶茶": 65,
                        "春芽鮮奶青": 65,
                        "三窨茉莉鮮奶綠": 65,
                        "黃金穀蕎麥鮮奶茶": 65,
                        "法式可可鮮奶茶": 85,
                        "靜岡抹茶鮮奶": 85,
                        "鮮榨蘋果歐蕾": 95
                    },
                    "鮮採小澄果": {
                        "鮮百香果綠": 60,
                        "百香波波綠": 70,
                        "鮮柳橙綠茶": 70,
                        "青釀脆梅綠": 55,
                        "鮮榨檸檬紅茶": 55,
                        "鮮榨檸檬綠茶": 55,
                        "鮮榨檸檬青茶": 55,
                        "鮮甘蔗青茶": 60,
                        "鮮甘蔗檸檬": 65,
                        "翡翠凍檸檬": 55,
                        "桃氣檸檬": 60,
                        "金鑽蜜鳳梨": 60,
                        "澄市水果茶": 70,
                        "鮮榨蘋果紅玉": 85,
                        "鮮榨蘋果綠茶": 85,
                        "鮮榨蘋果青茶": 85
                    },
                    "醇韻奶茶": {
                        "復刻奶茶": 50,
                        "奶茶(綠)": 50,
                        "奶茶(青)": 50,
                        "黃金穀蕎麥奶茶": 55,
                        "冰淇淋紅茶": 50,
                        "珍珠奶茶": 55,
                        "翡翠凍奶綠": 60,
                        "波波四季奶青": 65
                    },
                    "塩雪澄市": {
                        "塩雪黃金穀蕎麥": 65,
                        "塩雪金萱蜜香紅": 60,
                        "塩雪三窨茉莉綠": 60,
                        "塩雪四季春青": 60,
                        "塩雪可可脆片": 95,
                        "塩雪抹茶之士": 95
                    },
                    "澄凍澄市": {
                        "澄凍茉莉綠": 45,
                        "澄凍柳橙綠": 80,
                        "澄凍甘蔗檸檬": 75,
                        "澄凍香檸綠": 60,
                        "澄凍鮮奶綠": 75
                    },
                    "季節限定": {
                        "四季芒果青茶": 70,
                        "三窨芒果綠茶": 70,
                        "楊枝甘露": 95,
                        "芒果雪霜歐蕾": 95,
                        "塩雪芒果芝士": 95,
                        "奇異果波波": 90
                    }
                },
                toppings: [
                    { name: "珍珠", price: 10 },
                    { name: "椰果", price: 10 },
                    { name: "布丁", price: 15 },
                    { name: "仙草", price: 10 },
                    { name: "愛玉", price: 15 },
                    { name: "蘆薈", price: 10 },
                    { name: "奶蓋", price: 20 },
                    { name: "鮮奶", price: 15 }
                ]
            },
            "50嵐": {
                name: "🧋 50嵐",
                categories: {
                    "賞味茶品": {
                        "蒸青綠茶": 35,
                        "烏龍紅茶": 35,
                        "高山烏龍青": 35,
                        "奶香金萱茶": 40,
                        "熟香烏龍茶": 40,
                        "龍焙功夫茶": 40
                    },
                    "鮮奶茶系列": {
                        "鮮奶紅茶": 60,
                        "鮮奶綠茶": 60,
                        "金萱鮮奶茶": 65,
                        "熟香鮮奶茶": 65,
                        "龍焙鮮奶茶": 65
                    },
                    "養樂多系列": {
                        "養樂多綠茶": 55,
                        "養樂多青茶": 55,
                        "養樂多金萱": 60
                    },
                    "蜂蜜系列": {
                        "蜂蜜紅茶": 55,
                        "蜂蜜綠茶": 55,
                        "紅茶雪泡": 35,
                        "奶茶雪泡": 50,
                        "奶綠雪泡": 50,
                        "巧克力雪泡": 55
                    },
                    "招牌系列": {
                        "50嵐招牌": 50,
                        "養樂多綠茶": 45,
                        "多多綠茶": 45,
                        "檸檬養樂多": 50,
                        "蘆薈蜜": 40,
                        "愛玉檸檬": 45
                    }
                },
                toppings: [
                    { name: "珍珠", price: 10 },
                    { name: "椰果", price: 10 },
                    { name: "布丁", price: 15 },
                    { name: "仙草", price: 10 },
                    { name: "愛玉", price: 10 },
                    { name: "蘆薈", price: 10 },
                    { name: "波霸", price: 10 },
                    { name: "寒天", price: 10 }
                ]
            },
            "南海茶道": {
                name: "🧋 南海茶道",
                categories: {
                    "現泡茶飲系列-金萱茶": {
                        "鹿谷金萱": 45,
                        "杉林溪金萱": 50,
                        "阿里山金萱": 60
                    },
                    "現泡茶飲系列-熱烏龍": {
                        "鹿谷熱烏龍": 50,
                        "杉林溪熱烏龍": 55,
                        "阿里山熱烏龍": 65
                    },
                    "現泡茶飲系列-烏龍青": {
                        "鹿谷烏龍青": 45,
                        "杉林溪烏龍青": 50,
                        "阿里山烏龍青": 60,
                        "梨山烏龍青": 85
                    },
                    "現泡茶飲系列-龍焙茶": {
                        "鹿谷龍焙茶": 55,
                        "杉林溪龍焙茶": 60,
                        "阿里山龍焙茶": 75,
                        "梨山龍焙茶": 95
                    },
                    "現泡茶飲系列-窨花茶": {
                        "桂花烏龍": 60,
                        "茉莉包種": 55
                    },
                    "現泡茶飲系列-熟成茶": {
                        "魚池紅玉": 60,
                        "瑞穗蜜香紅茶": 60,
                        "峨眉東方美人": 60
                    },
                    "原茶調飲系列-營味茶品": {
                        "蒸青綠茶": 35,
                        "烏龍紅茶": 35,
                        "高山烏龍青": 35,
                        "奶香金萱茶": 40,
                        "熟香烏龍茶": 40,
                        "龍焙功夫茶": 40
                    },
                    "原茶調飲系列-蜂蜜系列": {
                        "蜂蜜紅茶": 55,
                        "蜂蜜綠茶": 55,
                        "蜂蜜金萱茶": 60,
                        "蜂蜜鮮奶紅茶": 80,
                        "蜂蜜鮮奶綠茶": 80,
                        "蜂蜜鮮奶金萱": 85,
                        "蜂蜜鮮奶龍焙": 85
                    },
                    "原茶調飲系列-鮮奶茶系列": {
                        "鮮奶紅茶": 60,
                        "鮮奶綠茶": 60,
                        "金萱鮮奶茶": 65,
                        "熟香鮮奶茶": 65,
                        "龍焙鮮奶茶": 65
                    },
                    "原茶調飲系列-養樂多系列": {
                        "養樂多綠茶": 55,
                        "養樂多青茶": 55,
                        "養樂多金萱": 60
                    },
                    "台灣果香系列": {
                        "檸檬紅茶": 55,
                        "檸檬綠茶": 55,
                        "蜂蜜檸檬": 70,
                        "柳丁綠茶": 65,
                        "柳丁青茶": 65,
                        "柳丁金萱": 70
                    },
                    "冬瓜茶系列": {
                        "冬瓜茶": 35,
                        "冬瓜青茶": 50,
                        "冬瓜檸檬": 55,
                        "冬瓜鮮奶": 60
                    }
                },
                toppings: [
                    { name: "珍珠", price: 10 },
                    { name: "椰果", price: 10 },
                    { name: "布丁", price: 15 },
                    { name: "仙草", price: 15 }
                ]
            }
        };

        // DOM 元素
        const loginPage = document.getElementById('loginPage');
        const adminPanel = document.getElementById('adminPanel');
        const mainPage = document.getElementById('mainPage');
        const roleSelect = document.getElementById('roleSelect');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const confirmStoreBtn = document.getElementById('confirmStoreBtn');
        const backToLoginBtn = document.getElementById('backToLoginBtn');
        const adminSwitchBtn = document.getElementById('adminSwitchBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const currentStoreName = document.getElementById('currentStoreName');
        const statusIndicator = document.getElementById('statusIndicator');
        const categorySelect = document.getElementById('categorySelect');
        const itemSelect = document.getElementById('itemSelect');
        const customerNameInput = document.getElementById('customerName');
        const optionsGroup = document.getElementById('optionsGroup');
        const sweetnessSelect = document.getElementById('sweetnessSelect');
        const iceSelect = document.getElementById('iceSelect');
        const toppingsGrid = document.getElementById('toppingsGrid');
        const quantityInput = document.getElementById('quantity');
        const addBtn = document.getElementById('addBtn');
        const orderTableBody = document.getElementById('orderTableBody');
        const lastUpdateSpan = document.getElementById('lastUpdate');
        const specialNotice = document.getElementById('specialNotice');
        const noticeText = document.getElementById('noticeText');

        // 登入功能
        function checkPassword() {
            const selectedRole = roleSelect.value;
            const inputPassword = passwordInput.value.trim();
            
            if (inputPassword === PASSWORDS[selectedRole]) {
                currentUserRole = selectedRole;
                localStorage.setItem('teaOrderAuth', JSON.stringify({
                    role: selectedRole,
                    timestamp: Date.now()
                }));
                
                if (selectedRole === 'admin') {
                    showAdminPanel();
                } else {
                    loadCurrentStore();
                }
            } else {
                showError('密碼錯誤，請重新輸入');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function showError(message) {
            loginError.textContent = message;
            loginError.style.display = 'block';
        }

        function showAdminPanel() {
            loginPage.style.display = 'none';
            adminPanel.style.display = 'block';
            loadStoreSelection();
        }

        function showMainPage() {
            loginPage.style.display = 'none';
            adminPanel.style.display = 'none';
            mainPage.style.display = 'block';
            initializeFirebase();
        }

        function logout() {
            localStorage.removeItem('teaOrderAuth');
            if (unsubscribe) unsubscribe();
            if (storeUnsubscribe) storeUnsubscribe();
            
            loginPage.style.display = 'block';
            adminPanel.style.display = 'none';
            mainPage.style.display = 'none';
            passwordInput.value = '';
            loginError.style.display = 'none';
            currentUserRole = null;
            currentStore = null;
        }

        // 載入當前店家設定
        async function loadCurrentStore() {
            try {
                statusIndicator.textContent = '載入店家資訊中...';
                statusIndicator.className = 'status-indicator status-loading';
                
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
                const { getFirestore, collection, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // 嘗試讀取店家設定
                try {
                    const storeConfigDoc = await getDoc(doc(db, 'config', 'currentStore'));
                    
                    if (storeConfigDoc.exists()) {
                        currentStore = storeConfigDoc.data().store;
                        showMainPage();
                    } else {
                        // 如果沒有設定，預設使用小澄市
                        console.log('沒有找到店家設定，使用預設店家');
                        currentStore = '小澄市';
                        showMainPage();
                    }
                } catch (permissionError) {
                    // 如果權限不足，使用預設店家
                    console.log('無法讀取店家設定，使用預設店家:', permissionError);
                    currentStore = '小澄市';
                    showMainPage();
                }
                
            } catch (error) {
                console.error('Firebase 初始化失敗:', error);
                // 即使 Firebase 初始化失敗，也使用預設店家
                currentStore = '小澄市';
                showMainPage();
            }
        }

        // 載入店家選擇狀態
        async function loadStoreSelection() {
            try {
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
                const { getFirestore, collection, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                try {
                    const storeConfigDoc = await getDoc(doc(db, 'config', 'currentStore'));
                    
                    if (storeConfigDoc.exists()) {
                        const currentStoreValue = storeConfigDoc.data().store;
                        const radioButton = document.querySelector(`input[name="selectedStore"][value="${currentStoreValue}"]`);
                        if (radioButton) {
                            radioButton.checked = true;
                        }
                    }
                } catch (permissionError) {
                    console.log('無法讀取店家選擇狀態:', permissionError);
                    // 預設選擇小澄市
                    const defaultRadio = document.querySelector('input[name="selectedStore"][value="小澄市"]');
                    if (defaultRadio) {
                        defaultRadio.checked = true;
                    }
                }
            } catch (error) {
                console.error('載入店家選擇失敗:', error);
                // 預設選擇小澄市
                const defaultRadio = document.querySelector('input[name="selectedStore"][value="小澄市"]');
                if (defaultRadio) {
                    defaultRadio.checked = true;
                }
            }
        }

        // 確認店家選擇
        async function confirmStoreSelection() {
            const selectedStore = document.querySelector('input[name="selectedStore"]:checked');
            
            if (!selectedStore) {
                alert('請選擇一間店家');
                return;
            }
            
            try {
                confirmStoreBtn.disabled = true;
                confirmStoreBtn.textContent = '設定中...';
                
                const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                
                try {
                    await setDoc(doc(db, 'config', 'currentStore'), {
                        store: selectedStore.value,
                        updatedAt: new Date(),
                        updatedBy: 'admin'
                    });
                    
                    currentStore = selectedStore.value;
                    showMainPage();
                } catch (permissionError) {
                    console.log('無法寫入店家設定，使用本地設定:', permissionError);
                    // 即使無法寫入 Firebase，也允許本地使用選定的店家
                    currentStore = selectedStore.value;
                    showMainPage();
                    alert('店家設定已在本次使用中生效（無法保存到雲端）');
                }
                
            } catch (error) {
                console.error('設定店家失敗:', error);
                // 即使失敗也使用選定的店家
                currentStore = selectedStore.value;
                showMainPage();
                alert('店家設定已在本次使用中生效');
            } finally {
                confirmStoreBtn.disabled = false;
                confirmStoreBtn.textContent = '確認並開始營業';
            }
        }

        // 初始化菜單
        function initializeMenu() {
            if (!currentStore || !storeMenus[currentStore]) {
                console.error('店家資料不存在:', currentStore);
                return;
            }
            
            const storeData = storeMenus[currentStore];
            
            // 更新店家名稱顯示
            currentStoreName.textContent = storeData.name;
            
            // 更新分類選單
            categorySelect.innerHTML = '<option value="">請選擇分類</option>';
            Object.keys(storeData.categories).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            
            // 更新加料選項
            updateToppingsOptions(storeData.toppings);
        }

        // 更新加料選項
        function updateToppingsOptions(toppings) {
            toppingsGrid.innerHTML = '';
            
            toppings.forEach((topping, index) => {
                const toppingDiv = document.createElement('div');
                toppingDiv.className = 'topping-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `topping${index + 1}`;
                checkbox.value = topping.name;
                checkbox.dataset.price = topping.price;
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = `${topping.name} (+${topping.price})`;
                
                toppingDiv.appendChild(checkbox);
                toppingDiv.appendChild(label);
                toppingsGrid.appendChild(toppingDiv);
            });
        }

        // 小澄市特殊規則檢查函數
        function isSaltSnowSeries(category) {
            return currentStore === '小澄市' && category === '塩雪澄市';
        }

        function isAppleAuLait(item) {
            return currentStore === '小澄市' && item === '鮮榨蘋果歐蕾';
        }

        function isSeasonalLimited(category) {
            return currentStore === '小澄市' && category === '季節限定';
        }

        function isMangoGreenTea(item) {
            return currentStore === '小澄市' && item === '三窨芒果綠茶';
        }

        function isMangoBaozhongTea(item) {
            return currentStore === '小澄市' && item === '四季芒果青茶';
        }

        function isIcecreamBlackTea(item) {
            return currentStore === '小澄市' && item === '冰淇淋紅茶';
        }

        function isMangoSeries(item) {
            return currentStore === '小澄市' && (item === '三窨芒果綠茶' || item === '四季芒果青茶');
        }

        function isSmoothie(item) {
            return currentStore === '小澄市' && ['翡翠凍檸檬', '桃氣檸檬', '金鑽蜜鳳梨', '澄市水果茶'].includes(item);
        }

        // 更新冰塊選項
        function updateIceOptions(category, item = null) {
            iceSelect.innerHTML = '';
            
            if (currentStore === '小澄市') {
                // 小澄市的特殊規則
                if (isSaltSnowSeries(category)) {
                    const saltSnowIceOptions = [
                        { value: '正常冰', text: '正常冰' },
                        { value: '少冰', text: '少冰' },
                        { value: '微冰', text: '微冰' }
                    ];
                    
                    saltSnowIceOptions.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        iceSelect.appendChild(optionElement);
                    });
                } else if (item && isMangoSeries(item)) {
                    const mangoIceOptions = [
                        { value: '正常冰', text: '正常冰' },
                        { value: '少冰', text: '少冰' },
                        { value: '微冰', text: '微冰' },
                        { value: '去冰', text: '去冰' }
                    ];
                    
                    mangoIceOptions.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        iceSelect.appendChild(optionElement);
                    });
                } else if (item && isIcecreamBlackTea(item)) {
                    const icecreamBlackTeaIceOptions = [
                        { value: '正常冰', text: '正常冰' },
                        { value: '少冰', text: '少冰' },
                        { value: '微冰', text: '微冰' },
                        { value: '去冰', text: '去冰' }
                    ];
                    
                    icecreamBlackTeaIceOptions.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        iceSelect.appendChild(optionElement);
                    });
                } else if (item && isSmoothie(item)) {
                    const smoothieIceOptions = [
                        { value: '正常冰', text: '正常冰' },
                        { value: '少冰', text: '少冰' },
                        { value: '微冰', text: '微冰' },
                        { value: '去冰', text: '去冰' },
                        { value: '冰沙', text: '冰沙' }
                    ];
                    
                    smoothieIceOptions.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        iceSelect.appendChild(optionElement);
                    });
                } else {
                    // 小澄市的正常選項
                    const normalIceOptions = [
                        { value: '正常冰', text: '正常冰' },
                        { value: '少冰', text: '少冰' },
                        { value: '微冰', text: '微冰' },
                        { value: '去冰', text: '去冰' },
                        { value: '完全去冰', text: '完全去冰' },
                        { value: '溫飲', text: '溫飲' },
                        { value: '熱飲', text: '熱飲' }
                    ];
                    
                    normalIceOptions.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        iceSelect.appendChild(optionElement);
                    });
                }
            } else {
                // 其他店家（如50嵐）的標準冰塊選項
                const standardIceOptions = [
                    { value: '正常冰', text: '正常冰' },
                    { value: '少冰', text: '少冰' },
                    { value: '微冰', text: '微冰' },
                    { value: '去冰', text: '去冰' },
                    { value: '溫飲', text: '溫飲' },
                    { value: '熱飲', text: '熱飲' }
                ];
                
                standardIceOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    iceSelect.appendChild(optionElement);
                });
            }
            
            iceSelect.value = '正常冰';
        }

        // 更新甜度選項
        function updateSweetnessOptions(item = null) {
            sweetnessSelect.innerHTML = '';
            
            if (currentStore === '小澄市' && item && isMangoSeries(item)) {
                // 小澄市芒果系列：最少微糖
                const mangoSweetnessOptions = [
                    { value: '正常甜', text: '正常甜' },
                    { value: '少糖', text: '少糖' },
                    { value: '半糖', text: '半糖' },
                    { value: '微糖', text: '微糖' },
                    { value: '1分糖', text: '1分糖' }
                ];
                
                mangoSweetnessOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    sweetnessSelect.appendChild(optionElement);
                });
            } else {
                // 標準甜度選項
                const normalSweetnessOptions = [
                    { value: '正常甜', text: '正常甜' },
                    { value: '少糖', text: '少糖' },
                    { value: '半糖', text: '半糖' },
                    { value: '微糖', text: '微糖' },
                    { value: '1分糖', text: '1分糖' },
                    { value: '無糖', text: '無糖' }
                ];
                
                normalSweetnessOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    sweetnessSelect.appendChild(optionElement);
                });
            }
            
            sweetnessSelect.value = '正常甜';
        }

        // 更新選項狀態
        function updateOptionsForItem(item, category) {
            updateSweetnessOptions(item);
            updateIceOptions(category, item);
            
            if (currentStore === '小澄市') {
                // 小澄市的特殊規則
                if (isAppleAuLait(item)) {
                    sweetnessSelect.disabled = true;
                    iceSelect.disabled = true;
                    sweetnessSelect.value = '正常甜';
                    iceSelect.value = '正常冰';
                    
                    specialNotice.style.display = 'block';
                    noticeText.textContent = '蘋果歐蕾的甜度和冰塊已固定，無法調整。';
                } else if (isSeasonalLimited(category) && (!isMangoGreenTea(item) && !isMangoBaozhongTea(item))) {
                    sweetnessSelect.disabled = true;
                    iceSelect.disabled = true;
                    sweetnessSelect.value = '正常甜';
                    iceSelect.value = '正常冰';
                    
                    specialNotice.style.display = 'block';
                    noticeText.textContent = '此季節限定飲品的甜度和冰塊已固定，無法調整。';
                } else {
                    sweetnessSelect.disabled = false;
                    iceSelect.disabled = false;
                    
                    let noticeMessages = [];
                    
                    if (isSaltSnowSeries(category)) {
                        noticeMessages.push('塩雪系列最低冰量為微冰，無法選擇去冰、溫飲或熱飲');
                    }
                    
                    if (isMangoSeries(item)) {
                        noticeMessages.push('芒果系列最低甜度為1分糖，無法選擇無糖');
                        noticeMessages.push('芒果系列無法選擇溫飲或熱飲');
                    }

                    if (isIcecreamBlackTea(item)) {
                        noticeMessages.push('冰淇淋紅茶無法選擇溫飲或熱飲');
                    }
                    
                    if (noticeMessages.length > 0) {
                        specialNotice.style.display = 'block';
                        noticeText.textContent = noticeMessages.join('；') + '。';
                    } else {
                        specialNotice.style.display = 'none';
                    }
                }
            } else {
                // 其他店家沒有特殊限制
                sweetnessSelect.disabled = false;
                iceSelect.disabled = false;
                specialNotice.style.display = 'none';
            }
        }

        // 初始化 Firebase
        async function initializeFirebase() {
            try {
                statusIndicator.textContent = '連接中...';
                statusIndicator.className = 'status-indicator status-loading';
                
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
                const { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, getDocs } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                
                window.firebaseFunctions = { addDoc, deleteDoc, doc, getDocs };
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                ordersRef = collection(db, 'orders');
                
                // 監聽當前店家變更（如果有權限的話）
                try {
                    storeUnsubscribe = onSnapshot(doc(db, 'config', 'currentStore'), (doc) => {
                        if (doc.exists()) {
                            const newStore = doc.data().store;
                            if (newStore !== currentStore) {
                                currentStore = newStore;
                                initializeMenu();
                                resetForm();
                            }
                        }
                    });
                } catch (permissionError) {
                    console.log('無法監聽店家變更，使用當前設定:', permissionError);
                }
                
                const q = query(ordersRef, orderBy('timestamp', 'desc'));
                unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const orders = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (!data.test && data.store === currentStore) {
                            orders.push({
                                id: doc.id,
                                ...data
                            });
                        }
                    });
                    updateOrderTable(orders);
                    updateSummary(orders);
                    lastUpdateSpan.textContent = new Date().toLocaleTimeString();
                });
                
                statusIndicator.textContent = '已連接';
                statusIndicator.className = 'status-indicator status-connected';
                
                initializeMenu();
                setupEventListeners();
                
                // 根據使用者角色顯示/隱藏管理功能
                updateUIForUserRole();
                
            } catch (error) {
                console.error('Firebase 初始化失敗:', error);
                statusIndicator.textContent = '連接失敗';
                statusIndicator.className = 'status-indicator status-disconnected';
            }
        }

        // 根據使用者角色更新UI
        function updateUIForUserRole() {
            const adminControls = document.getElementById('adminControls');
            const adminSwitchBtn = document.getElementById('adminSwitchBtn');
            
            if (currentUserRole === 'admin') {
                // 管理員：顯示所有管理功能
                adminControls.style.display = 'block';
                adminSwitchBtn.style.display = 'block';
            } else {
                // 一般使用者：隱藏管理功能
                adminControls.style.display = 'none';
                adminSwitchBtn.style.display = 'none';
            }
        }

        // 重置表單
        function resetForm() {
            categorySelect.value = '';
            itemSelect.innerHTML = '<option value="">請先選擇分類</option>';
            itemSelect.disabled = true;
            customerNameInput.value = '';
            customerNameInput.disabled = true;
            optionsGroup.style.display = 'none';
            quantityInput.value = 1;
            quantityInput.disabled = true;
            addBtn.disabled = true;
            specialNotice.style.display = 'none';
            
            // 重置加料選項
            const toppingInputs = document.querySelectorAll('#toppingsGrid input[type="checkbox"]');
            toppingInputs.forEach(input => input.checked = false);
        }

        // 新增訂單
        async function addOrder() {
            if (!db || !window.firebaseFunctions) {
                alert('請稍候，系統正在連接中...');
                return;
            }
            
            const category = categorySelect.value;
            const item = itemSelect.value;
            const customerName = customerNameInput.value.trim();
            const quantity = parseInt(quantityInput.value);
            const basePrice = parseInt(itemSelect.selectedOptions[0].dataset.price);
            const sweetness = sweetnessSelect.value;
            const ice = iceSelect.value;
            
            if (!customerName) {
                alert('請填入顧客姓名！');
                customerNameInput.focus();
                return;
            }
            
            const toppings = [];
            let toppingPrice = 0;
            const toppingInputs = document.querySelectorAll('#toppingsGrid input[type="checkbox"]:checked');
            toppingInputs.forEach(input => {
                toppings.push(input.value);
                toppingPrice += parseInt(input.dataset.price);
            });
            
            const totalPrice = basePrice + toppingPrice;
            const toppingsText = toppings.length > 0 ? toppings.join(', ') : '無';

            if (category && item && quantity > 0) {
                try {
                    addBtn.disabled = true;
                    addBtn.textContent = '新增中...';
                    
                    const orderData = {
                        store: currentStore,
                        customerName: customerName,
                        category: category,
                        item: item,
                        sweetness: sweetness,
                        ice: ice,
                        toppings: toppingsText,
                        basePrice: basePrice,
                        toppingPrice: toppingPrice,
                        totalPrice: totalPrice,
                        quantity: quantity,
                        subtotal: totalPrice * quantity,
                        timestamp: new Date()
                    };
                    
                    await window.firebaseFunctions.addDoc(ordersRef, orderData);
                    
                    customerNameInput.value = '';
                    quantityInput.value = 1;
                    sweetnessSelect.value = '正常甜';
                    iceSelect.value = '正常冰';
                    toppingInputs.forEach(input => input.checked = false);
                    
                } catch (error) {
                    console.error('新增訂單失敗:', error);
                    alert('新增訂單失敗，請重試');
                } finally {
                    addBtn.disabled = false;
                    addBtn.textContent = '新增到訂單';
                }
            }
        }

        // 刪除訂單（僅管理員）
        async function removeOrder(orderId) {
            if (currentUserRole !== 'admin') {
                alert('此功能僅限管理員使用');
                return;
            }
            
            if (!db || !window.firebaseFunctions) return;
            
            if (confirm('確定要刪除這筆訂單嗎？')) {
                try {
                    await window.firebaseFunctions.deleteDoc(window.firebaseFunctions.doc(db, 'orders', orderId));
                } catch (error) {
                    console.error('刪除訂單失敗:', error);
                    alert('刪除訂單失敗，請重試');
                }
            }
        }

        // 清空所有訂單（僅管理員）
        async function clearAllOrders() {
            if (currentUserRole !== 'admin') {
                alert('此功能僅限管理員使用');
                return;
            }
            
            if (!db || !window.firebaseFunctions) return;
            
            if (confirm('確定要清空所有訂單嗎？此操作無法復原！\n\n⚠️ 此操作僅限管理員執行')) {
                try {
                    const snapshot = await window.firebaseFunctions.getDocs(ordersRef);
                    const deletePromises = [];
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (!data.test && data.store === currentStore) {
                            deletePromises.push(window.firebaseFunctions.deleteDoc(doc.ref));
                        }
                    });
                    
                    await Promise.all(deletePromises);
                    alert('所有訂單已清空');
                } catch (error) {
                    console.error('清空訂單失敗:', error);
                    alert('清空訂單失敗，請重試');
                }
            }
        }

        // 更新訂單表格
        function updateOrderTable(orders) {
            if (orders.length === 0) {
                orderTableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">目前沒有訂單</td></tr>';
                return;
            }

            let html = '';
            orders.forEach((order, index) => {
                const priceDetail = order.toppingPrice > 0 ? 
                    `NT$ ${order.basePrice} + ${order.toppingPrice}` : 
                    `NT$ ${order.basePrice}`;
                
                const orderTime = order.timestamp ? 
                    new Date(order.timestamp.seconds * 1000).toLocaleTimeString() : 
                    '未知';
                
                html += `
                    <tr>
                        <td>${orderTime}</td>
                        <td>${order.customerName}</td>
                        <td>${order.category}</td>
                        <td>${order.item}</td>
                        <td>${order.sweetness}</td>
                        <td>${order.ice}</td>
                        <td>${order.toppings}</td>
                        <td>${priceDetail}</td>
                        <td>${order.quantity}</td>
                        <td>NT$ ${order.subtotal}</td>
                        <td>
                            ${currentUserRole === 'admin' ? 
                                `<button class="remove-btn" data-order-id="${order.id}">刪除</button>` : 
                                '-'
                            }
                        </td>
                    </tr>
                `;
            });

            const totalAmount = orders.reduce((sum, order) => sum + order.subtotal, 0);
            const totalQuantity = orders.reduce((sum, order) => sum + order.quantity, 0);
            
            html += `
                <tr class="total-row">
                    <td colspan="8">總計</td>
                    <td>${totalQuantity}</td>
                    <td>NT$ ${totalAmount}</td>
                    <td>-</td>
                </tr>
            `;

            orderTableBody.innerHTML = html;
            
            const removeButtons = orderTableBody.querySelectorAll('.remove-btn');
            removeButtons.forEach(button => {
                if (button.dataset.orderId) {
                    button.addEventListener('click', () => removeOrder(button.dataset.orderId));
                }
            });
        }

        // 更新統計摘要
        function updateSummary(orders) {
            const totalItems = orders.length;
            const totalQuantity = orders.reduce((sum, order) => sum + order.quantity, 0);
            const totalAmount = orders.reduce((sum, order) => sum + order.subtotal, 0);
            const uniqueCustomers = new Set(orders.map(order => order.customerName)).size;

            document.getElementById('uniqueCustomers').textContent = uniqueCustomers;
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalQuantity').textContent = totalQuantity;
            document.getElementById('totalAmount').textContent = `NT$ ${totalAmount}`;
        }

        // 匯出 CSV
        function exportToCSV() {
            const table = document.getElementById('orderTable');
            const rows = table.querySelectorAll('tbody tr');
            
            if (rows.length <= 1) {
                alert('沒有訂單資料可以匯出');
                return;
            }

            let csv = `店家,時間,顧客姓名,分類,品項,甜度,冰塊,加料,基本價格,加料價格,總單價,數量,小計\n`;
            
            for (let i = 0; i < rows.length - 1; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td');
                
                if (cells.length >= 10) {
                    const time = cells[0].textContent.trim();
                    const customerName = cells[1].textContent.trim();
                    const category = cells[2].textContent.trim();
                    const item = cells[3].textContent.trim();
                    const sweetness = cells[4].textContent.trim();
                    const ice = cells[5].textContent.trim();
                    const toppings = cells[6].textContent.trim();
                    const priceText = cells[7].textContent.trim();
                    const quantity = cells[8].textContent.trim();
                    const subtotal = cells[9].textContent.replace('NT$ ', '').trim();
                    
                    let basePrice = '';
                    let toppingPrice = '0';
                    let totalPrice = '';
                    
                    if (priceText.includes(' + ')) {
                        const prices = priceText.split(' + ');
                        basePrice = prices[0].replace('NT$ ', '');
                        toppingPrice = prices[1];
                        totalPrice = (parseInt(basePrice) + parseInt(toppingPrice)).toString();
                    } else {
                        basePrice = priceText.replace('NT$ ', '');
                        totalPrice = basePrice;
                    }
                    
                    csv += `"${currentStore}","${time}","${customerName}","${category}","${item}","${sweetness}","${ice}","${toppings}",${basePrice},${toppingPrice},${totalPrice},${quantity},${subtotal}\n`;
                }
            }

            const totalRow = rows[rows.length - 1];
            if (totalRow && totalRow.classList.contains('total-row')) {
                const totalCells = totalRow.querySelectorAll('td');
                if (totalCells.length >= 3) {
                    const totalQuantity = totalCells[totalCells.length - 2].textContent.trim();
                    const totalAmount = totalCells[totalCells.length - 1].textContent.replace('NT$ ', '').trim();
                    csv += `"${currentStore}",總計,,,,,,,,,${totalQuantity},${totalAmount}\n`;
                }
            }

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${currentStore}_訂單_${new Date().toISOString().slice(0, 10)}.csv`);
            link.click();
        }

        // 設定事件監聽器
        function setupEventListeners() {
            categorySelect.addEventListener('change', function() {
                const category = this.value;
                itemSelect.innerHTML = '<option value="">請選擇品項</option>';
                
                if (category && currentStore && storeMenus[currentStore] && storeMenus[currentStore].categories[category]) {
                    updateIceOptions(category);
                    updateSweetnessOptions();
                    
                    Object.keys(storeMenus[currentStore].categories[category]).forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;
                        option.textContent = `${item} - NT$ ${storeMenus[currentStore].categories[category][item]}`;
                        option.dataset.price = storeMenus[currentStore].categories[category][item];
                        itemSelect.appendChild(option);
                    });
                    itemSelect.disabled = false;
                    customerNameInput.disabled = false;
                } else {
                    itemSelect.disabled = true;
                    customerNameInput.disabled = true;
                    optionsGroup.style.display = 'none';
                    quantityInput.disabled = true;
                    addBtn.disabled = true;
                    specialNotice.style.display = 'none';
                }
            });

            itemSelect.addEventListener('change', function() {
                const item = this.value;
                const category = categorySelect.value;
                
                if (item) {
                    optionsGroup.style.display = 'block';
                    quantityInput.disabled = false;
                    addBtn.disabled = false;
                    
                    updateOptionsForItem(item, category);
                } else {
                    optionsGroup.style.display = 'none';
                    quantityInput.disabled = true;
                    addBtn.disabled = true;
                    specialNotice.style.display = 'none';
                    
                    updateSweetnessOptions();
                }
            });

            addBtn.addEventListener('click', addOrder);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('clearBtn').addEventListener('click', clearAllOrders);
        }

        // 重置甜度選項為預設
        function resetSweetnessOptions() {
            updateSweetnessOptions(null);
        }

        // 事件監聽器設定
        loginBtn.addEventListener('click', checkPassword);
        confirmStoreBtn.addEventListener('click', confirmStoreSelection);
        backToLoginBtn.addEventListener('click', () => {
            adminPanel.style.display = 'none';
            loginPage.style.display = 'block';
        });
        adminSwitchBtn.addEventListener('click', () => {
            if (currentUserRole === 'admin') {
                showAdminPanel();
            } else {
                alert('您沒有管理員權限');
            }
        });
        logoutBtn.addEventListener('click', logout);
        
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // 頁面載入時檢查是否已登入
        window.addEventListener('load', function() {
            const authData = localStorage.getItem('teaOrderAuth');
            if (authData) {
                try {
                    const parsed = JSON.parse(authData);
                    const now = Date.now();
                    const loginTime = parsed.timestamp;
                    
                    // 檢查登入是否在24小時內
                    if (now - loginTime < 24 * 60 * 60 * 1000) {
                        currentUserRole = parsed.role;
                        
                        if (parsed.role === 'admin') {
                            // 管理員可以選擇進入管理面板或直接進入系統
                            showAdminPanel();
                        } else {
                            loadCurrentStore();
                        }
                    } else {
                        // 登入過期
                        localStorage.removeItem('teaOrderAuth');
                        passwordInput.focus();
                    }
                } catch (error) {
                    localStorage.removeItem('teaOrderAuth');
                    passwordInput.focus();
                }
            } else {
                passwordInput.focus();
            }
        });

        // 頁面關閉時清理監聽器
        window.addEventListener('beforeunload', function() {
            if (unsubscribe) unsubscribe();
            if (storeUnsubscribe) storeUnsubscribe();
        });

        // 全域函數
        window.removeOrder = removeOrder;
    </script>
</body>
</html>