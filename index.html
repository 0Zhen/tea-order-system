<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§‹ å°æ¾„å¸‚</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 40px;
            text-align: center;
        }
        
        .login-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
        }
        
        .error-message {
            color: #dc3545;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .status-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-connected {
            background: #28a745;
            color: white;
        }
        
        .status-disconnected {
            background: #dc3545;
            color: white;
        }
        
        .status-loading {
            background: #ffc107;
            color: #333;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .options-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .option-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .option-section label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .toppings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 5px;
        }
        
        .topping-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        
        .topping-item input[type="checkbox"] {
            margin: 0;
        }
        
        .control-group label {
            font-weight: bold;
            min-width: 80px;
        }
        
        select, input, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        select {
            min-width: 200px;
        }
        
        input[type="number"] {
            width: 80px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .admin-controls {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .admin-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2d5a2d;
        }
        
        .table-container {
            overflow-x: auto;
            padding: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        tr:hover {
            background: #e9ecef;
        }
        
        .total-row {
            background: #e3f2fd !important;
            font-weight: bold;
        }
        
        .summary {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .summary h3 {
            margin: 0 0 10px 0;
            color: #2d5a2d;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        @media (max-width: 768px) {
            .login-container {
                margin: 20px auto;
                padding: 30px 20px;
            }
            
            .container {
                margin: 10px;
                border-radius: 0;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group label {
                min-width: auto;
            }
            
            select, input {
                min-width: auto;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥é é¢ -->
    <div id="loginPage" class="login-container">
        <div class="login-title">ğŸ§‹ å°æ¾„å¸‚</div>
        <div class="login-subtitle">è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¹¼çºŒ</div>
        <input type="password" id="passwordInput" class="password-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
        <button id="loginBtn" class="login-btn">ç™»å…¥</button>
        <div id="loginError" class="error-message" style="display: none;"></div>
    </div>

    <!-- ä¸»è¦ç³»çµ±é é¢ -->
    <div id="mainPage" class="container">
        <div class="header">
            <h1>ğŸ§‹ å°æ¾„å¸‚</h1>
            <p>å³æ™‚åŒæ­¥ï¼Œå¤šäººå”ä½œé»é¤</p>
            <button id="logoutBtn" class="logout-btn">ç™»å‡º</button>
            <div id="statusIndicator" class="status-indicator status-loading">é€£æ¥ä¸­...</div>
        </div>
        
        <!-- ç®¡ç†è€…æ§åˆ¶é¢æ¿ -->
        <div class="admin-controls">
            <div class="admin-title">ğŸ“Š ç®¡ç†è€…æ§åˆ¶é¢æ¿</div>
            <div class="control-group">
                <button id="exportBtn" class="btn-success">åŒ¯å‡ºæ‰€æœ‰è¨‚å–® CSV</button>
                <button id="clearBtn" class="btn-danger">æ¸…ç©ºæ‰€æœ‰è¨‚å–®</button>
                <span style="margin-left: 20px; font-weight: bold;">å³æ™‚æ›´æ–°ï¼š<span id="lastUpdate">-</span></span>
            </div>
        </div>
        
        <!-- é»é¤è¡¨å–® -->
        <div class="controls">
            <div class="control-group">
                <label>é¸æ“‡åˆ†é¡ï¼š</label>
                <select id="categorySelect">
                    <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                    <option value="åŸèƒå°èŒ¶é¤¨">åŸèƒå°èŒ¶é¤¨</option>
                    <option value="é€ å¸‚å°ç§˜å¢ƒ">é€ å¸‚å°ç§˜å¢ƒ</option>
                    <option value="é®®æ¦¨å°æ¸…ç¿ ">é®®æ¦¨å°æ¸…ç¿ </option>
                    <option value="é†‡éŸ»å¥¶èŒ¶">é†‡éŸ»å¥¶èŒ¶</option>
                    <option value="é‚€èŒ¶å¸‚">é‚€èŒ¶å¸‚</option>
                    <option value="ç¾å¦™é™å®š">ç¾å¦™é™å®š</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>é¸æ“‡å“é …ï¼š</label>
                <select id="itemSelect" disabled>
                    <option value="">è«‹å…ˆé¸æ“‡åˆ†é¡</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>é¡§å®¢å§“åï¼š</label>
                <input type="text" id="customerName" placeholder="è«‹è¼¸å…¥é¡§å®¢å§“å" disabled style="min-width: 150px;">
            </div>
            
            <div class="options-group" id="optionsGroup" style="display: none;">
                <div class="option-section">
                    <label>ç”œåº¦ï¼š</label>
                    <select id="sweetnessSelect">
                        <option value="æ­£å¸¸ç”œ">æ­£å¸¸ç”œ</option>
                        <option value="å°‘ç³–">å°‘ç³–</option>
                        <option value="åŠç³–">åŠç³–</option>
                        <option value="å¾®ç³–">å¾®ç³–</option>
                        <option value="1åˆ†ç³–">1åˆ†ç³–</option>
                        <option value="ç„¡ç³–">ç„¡ç³–</option>
                    </select>
                </div>
                
                <div class="option-section">
                    <label>å†°å¡Šï¼š</label>
                    <select id="iceSelect">
                        <option value="æ­£å¸¸å†°">æ­£å¸¸å†°</option>
                        <option value="å°‘å†°">å°‘å†°</option>
                        <option value="å¾®å†°">å¾®å†°</option>
                        <option value="å»å†°">å»å†°</option>
                        <option value="æº«é£²">æº«é£²</option>
                        <option value="ç†±é£²">ç†±é£²</option>
                    </select>
                </div>
                
                <div class="option-section">
                    <label>åŠ æ–™ï¼š</label>
                    <div class="toppings-grid">
                        <div class="topping-item">
                            <input type="checkbox" id="topping1" value="çç " data-price="10">
                            <label for="topping1">çç  (+$10)</label>
                        </div>
                        <div class="topping-item">
                            <input type="checkbox" id="topping2" value="æ¤°æœ" data-price="10">
                            <label for="topping2">æ¤°æœ (+$10)</label>
                        </div>
                        <div class="topping-item">
                            <input type="checkbox" id="topping3" value="å¸ƒä¸" data-price="15">
                            <label for="topping3">å¸ƒä¸ (+$15)</label>
                        </div>
                        <div class="topping-item">
                            <input type="checkbox" id="topping4" value="ä»™è‰" data-price="10">
                            <label for="topping4">ä»™è‰ (+$10)</label>
                        </div>
                        <div class="topping-item">
                            <input type="checkbox" id="topping5" value="æ„›ç‰" data-price="15">
                            <label for="topping5">æ„›ç‰ (+$15)</label>
                        </div>
                        <div class="topping-item">
                            <input type="checkbox" id="topping6" value="è˜†è–ˆ" data-price="10">
                            <label for="topping6">è˜†è–ˆ (+$10)</label>
                        </div>
                        <div class="topping-item">
                            <input type="checkbox" id="topping7" value="å¥¶è“‹" data-price="20">
                            <label for="topping7">å¥¶è“‹ (+$20)</label>
                        </div>
                        <div class="topping-item">
                            <input type="checkbox" id="topping8" value="é®®å¥¶" data-price="15">
                            <label for="topping8">é®®å¥¶ (+$15)</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <label>æ•¸é‡ï¼š</label>
                <input type="number" id="quantity" min="1" value="1" disabled>
                <button id="addBtn" disabled>æ–°å¢åˆ°è¨‚å–®</button>
            </div>
        </div>
        
        <!-- å³æ™‚è¨‚å–®è¡¨æ ¼ -->
        <div class="table-container">
            <table id="orderTable">
                <thead>
                    <tr>
                        <th>æ™‚é–“</th>
                        <th>é¡§å®¢å§“å</th>
                        <th>åˆ†é¡</th>
                        <th>å“é …</th>
                        <th>ç”œåº¦</th>
                        <th>å†°å¡Š</th>
                        <th>åŠ æ–™</th>
                        <th>å–®åƒ¹</th>
                        <th>æ•¸é‡</th>
                        <th>å°è¨ˆ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    <tr>
                        <td colspan="11" style="text-align: center; color: #666;">è¼‰å…¥ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- çµ±è¨ˆæ‘˜è¦ -->
        <div class="summary">
            <h3>ğŸ“Š å³æ™‚çµ±è¨ˆ</h3>
            <div class="summary-item">
                <span>ä¸åŒé¡§å®¢æ•¸ï¼š</span>
                <span id="uniqueCustomers">0</span>
            </div>
            <div class="summary-item">
                <span>ç¸½å“é …æ•¸ï¼š</span>
                <span id="totalItems">0</span>
            </div>
            <div class="summary-item">
                <span>ç¸½æ•¸é‡ï¼š</span>
                <span id="totalQuantity">0</span>
            </div>
            <div class="summary-item">
                <span>ç¸½é‡‘é¡ï¼š</span>
                <span id="totalAmount">NT$ 0</span>
            </div>
        </div>
    </div>

    <script type="module">
        // å¯†ç¢¼è¨­å®šï¼ˆæ‚¨å¯ä»¥ä¿®æ”¹é€™å€‹å¯†ç¢¼ï¼‰
        const SYSTEM_PASSWORD = 'hy123';
        
        // Firebase è¨­å®šï¼ˆå·²å…§åµŒï¼‰
        const firebaseConfig = {
            "apiKey": "AIzaSyC6BlzAWm2PFBRJrtzySyI0spJrk-DIuvA",
            "authDomain": "order-collect-eb163.firebaseapp.com",
            "projectId": "order-collect-eb163",
            "storageBucket": "order-collect-eb163.firebasestorage.app",
            "messagingSenderId": "276173896243",
            "appId": "1:276173896243:web:e7cc9f400d4d509699c146",
            "measurementId": "G-2NCH0KCLRZ"
        };
        
        // å…¨åŸŸè®Šæ•¸
        let db = null;
        let ordersRef = null;
        let unsubscribe = null;
        
        const menuData = {
            "åŸèƒå°èŒ¶é¤¨": {
                "å¤œéŸ»ç´…èŒ¶": 35,
                "é‡‘è±èœœé¦™ç´…èŒ¶": 35,
                "é»ƒé‡‘çƒé¾èŒ¶": 40,
                "å››å­£æ˜¥é’èŒ¶": 35,
                "ä¸‰æºèŒ‰è‰ç¶ èŒ¶": 35
            },
            "é€ å¸‚å°ç§˜å¢ƒ": {
                "é‡‘è±èœœé¦™ç´…èŒ¶": 65,
                "æ˜¥èŠ½èœœé¦™é’": 65,
                "ä¸‰æºèŒ‰è‰ç¶ èŒ¶çµ²": 65,
                "é»ƒé‡‘çƒé¾èœœé¦™å¥¶èŒ¶": 65,
                "æ³•å¼å¯å¯é®®å¥¶èŒ¶": 85,
                "ç„™å’–å•¡æŠ¹èŒ¶æ‹¿éµ": 85,
                "é®®æ¦¨è˜‹æœèœœé¦™å¥¶èŒ¶": 95
            },
            "é®®æ¦¨å°æ¸…ç¿ ": {
                "é®®ç™¾é¦™ç¶ èŒ¶": 60,
                "ç™¾é¦™æ³¢æ³¢èŒ¶": 70,
                "é®®æ¦¨æª¸æª¬èŒ¶": 70,
                "é’æª¸æ°£æ³¡èŒ¶": 55,
                "é®®æ¦¨æª¸æª¬èŒ¶": 55,
                "èœ‚èœœæª¸æª¬èŒ¶": 60,
                "é®®æ¦¨è˜‹æœç´…èŒ¶": 65,
                "æª¸æª¬å¤¾é’èŒ¶": 55,
                "ä¾¯èŒ¶æª¸æª¬ç´…èŒ¶": 60,
                "é‡‘è±èœœé¦™ç´…èŒ¶": 60,
                "é€ å¸‚æ°´æœèŒ¶": 70,
                "é®®æ¦¨è˜‹æœç´…èŒ¶": 85
            },
            "é†‡éŸ»å¥¶èŒ¶": {
                "å¥¶èŒ¶": 50,
                "é»ƒé‡‘çƒé¾å¥¶èŒ¶": 55,
                "å†°æ·‡æ·‹ç´…èŒ¶": 50,
                "çç å¥¶èŒ¶": 55,
                "ç´…èŒ¶æ‹¿éµ": 60,
                "ç‡•éº¥å¥¶èŒ¶": 65
            },
            "é‚€èŒ¶å¸‚": {
                "é€ å¸‚èŒ¶å‡": 45,
                "é€ å¸‚é®®å¥¶èŒ¶": 80,
                "é€ å¸‚æ—¥å¼å¥¶èŒ¶": 75,
                "é€ å¸‚é¦™æª¸èŒ¶": 60,
                "é€ å¸‚èœ‚èœœèŒ¶": 75
            },
            "ç¾å¦™é™å®š": {
                "ç‡’çƒ¤è²æ®¼å¥¶èŒ¶": 95,
                "èŠ’æœèœœé¦™å¥¶èŒ¶": 95,
                "èœ‚èœœèŠ’æœå¥¶èŒ¶": 95,
                "é¦™è‰èœœé¦™å¥¶èŒ¶": 90
            }
        };

        // DOM å…ƒç´ 
        const loginPage = document.getElementById('loginPage');
        const mainPage = document.getElementById('mainPage');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const categorySelect = document.getElementById('categorySelect');
        const itemSelect = document.getElementById('itemSelect');
        const customerNameInput = document.getElementById('customerName');
        const optionsGroup = document.getElementById('optionsGroup');
        const sweetnessSelect = document.getElementById('sweetnessSelect');
        const iceSelect = document.getElementById('iceSelect');
        const quantityInput = document.getElementById('quantity');
        const addBtn = document.getElementById('addBtn');
        const orderTableBody = document.getElementById('orderTableBody');
        const lastUpdateSpan = document.getElementById('lastUpdate');

        // ç™»å…¥åŠŸèƒ½
        function checkPassword() {
            const inputPassword = passwordInput.value.trim();
            if (inputPassword === SYSTEM_PASSWORD) {
                localStorage.setItem('teaOrderAuth', 'true');
                showMainPage();
            } else {
                showError('å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function showError(message) {
            loginError.textContent = message;
            loginError.style.display = 'block';
        }

        function showMainPage() {
            loginPage.style.display = 'none';
            mainPage.style.display = 'block';
            initializeFirebase();
        }

        function logout() {
            localStorage.removeItem('teaOrderAuth');
            if (unsubscribe) {
                unsubscribe();
            }
            loginPage.style.display = 'block';
            mainPage.style.display = 'none';
            passwordInput.value = '';
            loginError.style.display = 'none';
        }

        // åˆå§‹åŒ– Firebase
        async function initializeFirebase() {
            try {
                statusIndicator.textContent = 'é€£æ¥ä¸­...';
                statusIndicator.className = 'status-indicator status-loading';
                
                // å‹•æ…‹è¼‰å…¥ Firebase SDK
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
                const { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, getDocs } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                
                // å°‡ Firebase å‡½æ•¸å­˜ç‚ºå…¨åŸŸè®Šæ•¸
                window.firebaseFunctions = { addDoc, deleteDoc, doc, getDocs };
                
                // åˆå§‹åŒ– Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                ordersRef = collection(db, 'orders');
                
                // è¨­å®šå³æ™‚ç›£è½
                const q = query(ordersRef, orderBy('timestamp', 'desc'));
                unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const orders = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (!data.test) {  // æ’é™¤æ¸¬è©¦è³‡æ–™
                            orders.push({
                                id: doc.id,
                                ...data
                            });
                        }
                    });
                    updateOrderTable(orders);
                    updateSummary(orders);
                    lastUpdateSpan.textContent = new Date().toLocaleTimeString();
                });
                
                statusIndicator.textContent = 'å·²é€£æ¥';
                statusIndicator.className = 'status-indicator status-connected';
                
                setupEventListeners();
                
            } catch (error) {
                console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
                statusIndicator.textContent = 'é€£æ¥å¤±æ•—';
                statusIndicator.className = 'status-indicator status-disconnected';
            }
        }

        // æ–°å¢è¨‚å–®
        async function addOrder() {
            if (!db || !window.firebaseFunctions) {
                alert('è«‹ç¨å€™ï¼Œç³»çµ±æ­£åœ¨é€£æ¥ä¸­...');
                return;
            }
            
            const category = categorySelect.value;
            const item = itemSelect.value;
            const customerName = customerNameInput.value.trim();
            const quantity = parseInt(quantityInput.value);
            const basePrice = parseInt(itemSelect.selectedOptions[0].dataset.price);
            const sweetness = sweetnessSelect.value;
            const ice = iceSelect.value;
            
            if (!customerName) {
                alert('è«‹å¡«å…¥é¡§å®¢å§“åï¼');
                customerNameInput.focus();
                return;
            }
            
            // è¨ˆç®—åŠ æ–™åƒ¹æ ¼
            const toppings = [];
            let toppingPrice = 0;
            const toppingInputs = document.querySelectorAll('input[type="checkbox"]:checked');
            toppingInputs.forEach(input => {
                toppings.push(input.value);
                toppingPrice += parseInt(input.dataset.price);
            });
            
            const totalPrice = basePrice + toppingPrice;
            const toppingsText = toppings.length > 0 ? toppings.join(', ') : 'ç„¡';

            if (category && item && quantity > 0) {
                try {
                    addBtn.disabled = true;
                    addBtn.textContent = 'æ–°å¢ä¸­...';
                    
                    const orderData = {
                        customerName: customerName,
                        category: category,
                        item: item,
                        sweetness: sweetness,
                        ice: ice,
                        toppings: toppingsText,
                        basePrice: basePrice,
                        toppingPrice: toppingPrice,
                        totalPrice: totalPrice,
                        quantity: quantity,
                        subtotal: totalPrice * quantity,
                        timestamp: new Date()
                    };
                    
                    await window.firebaseFunctions.addDoc(ordersRef, orderData);
                    
                    // é‡ç½®è¡¨å–®
                    customerNameInput.value = '';
                    quantityInput.value = 1;
                    sweetnessSelect.value = 'æ­£å¸¸ç”œ';
                    iceSelect.value = 'æ­£å¸¸å†°';
                    toppingInputs.forEach(input => input.checked = false);
                    
                } catch (error) {
                    console.error('æ–°å¢è¨‚å–®å¤±æ•—:', error);
                    alert('æ–°å¢è¨‚å–®å¤±æ•—ï¼Œè«‹é‡è©¦');
                } finally {
                    addBtn.disabled = false;
                    addBtn.textContent = 'æ–°å¢åˆ°è¨‚å–®';
                }
            }
        }

        // åˆªé™¤è¨‚å–®
        async function removeOrder(orderId) {
            if (!db || !window.firebaseFunctions) return;
            
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ')) {
                try {
                    await window.firebaseFunctions.deleteDoc(window.firebaseFunctions.doc(db, 'orders', orderId));
                } catch (error) {
                    console.error('åˆªé™¤è¨‚å–®å¤±æ•—:', error);
                    alert('åˆªé™¤è¨‚å–®å¤±æ•—ï¼Œè«‹é‡è©¦');
                }
            }
        }

        // æ¸…ç©ºæ‰€æœ‰è¨‚å–®
        async function clearAllOrders() {
            if (!db || !window.firebaseFunctions) return;
            
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                try {
                    const snapshot = await window.firebaseFunctions.getDocs(ordersRef);
                    const deletePromises = [];
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (!data.test) {  // ä¸åˆªé™¤æ¸¬è©¦è³‡æ–™
                            deletePromises.push(window.firebaseFunctions.deleteDoc(doc.ref));
                        }
                    });
                    
                    await Promise.all(deletePromises);
                    alert('æ‰€æœ‰è¨‚å–®å·²æ¸…ç©º');
                } catch (error) {
                    console.error('æ¸…ç©ºè¨‚å–®å¤±æ•—:', error);
                    alert('æ¸…ç©ºè¨‚å–®å¤±æ•—ï¼Œè«‹é‡è©¦');
                }
            }
        }

        // æ›´æ–°è¨‚å–®è¡¨æ ¼
        function updateOrderTable(orders) {
            if (orders.length === 0) {
                orderTableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">ç›®å‰æ²’æœ‰è¨‚å–®</td></tr>';
                return;
            }

            let html = '';
            orders.forEach((order, index) => {
                const priceDetail = order.toppingPrice > 0 ? 
                    `NT$ ${order.basePrice} + ${order.toppingPrice}` : 
                    `NT$ ${order.basePrice}`;
                
                const orderTime = order.timestamp ? 
                    new Date(order.timestamp.seconds * 1000).toLocaleTimeString() : 
                    'æœªçŸ¥';
                
                html += `
                    <tr>
                        <td>${orderTime}</td>
                        <td>${order.customerName}</td>
                        <td>${order.category}</td>
                        <td>${order.item}</td>
                        <td>${order.sweetness}</td>
                        <td>${order.ice}</td>
                        <td>${order.toppings}</td>
                        <td>${priceDetail}</td>
                        <td>${order.quantity}</td>
                        <td>NT$ ${order.subtotal}</td>
                        <td>
                            <button class="remove-btn" data-order-id="${order.id}">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            });

            const totalAmount = orders.reduce((sum, order) => sum + order.subtotal, 0);
            const totalQuantity = orders.reduce((sum, order) => sum + order.quantity, 0);
            
            html += `
                <tr class="total-row">
                    <td colspan="8">ç¸½è¨ˆ</td>
                    <td>${totalQuantity}</td>
                    <td>NT$ ${totalAmount}</td>
                    <td>-</td>
                </tr>
            `;

            orderTableBody.innerHTML = html;
            
            // ç‚ºåˆªé™¤æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
            const removeButtons = orderTableBody.querySelectorAll('.remove-btn');
            removeButtons.forEach(button => {
                if (button.dataset.orderId) {
                    button.addEventListener('click', () => removeOrder(button.dataset.orderId));
                }
            });
        }

        // æ›´æ–°çµ±è¨ˆæ‘˜è¦
        function updateSummary(orders) {
            const totalItems = orders.length;
            const totalQuantity = orders.reduce((sum, order) => sum + order.quantity, 0);
            const totalAmount = orders.reduce((sum, order) => sum + order.subtotal, 0);
            const uniqueCustomers = new Set(orders.map(order => order.customerName)).size;

            document.getElementById('uniqueCustomers').textContent = uniqueCustomers;
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalQuantity').textContent = totalQuantity;
            document.getElementById('totalAmount').textContent = `NT$ ${totalAmount}`;
        }

        // åŒ¯å‡º CSV
        function exportToCSV() {
            const table = document.getElementById('orderTable');
            const rows = table.querySelectorAll('tbody tr');
            
            if (rows.length <= 1) {
                alert('æ²’æœ‰è¨‚å–®è³‡æ–™å¯ä»¥åŒ¯å‡º');
                return;
            }

            let csv = 'æ™‚é–“,é¡§å®¢å§“å,åˆ†é¡,å“é …,ç”œåº¦,å†°å¡Š,åŠ æ–™,åŸºæœ¬åƒ¹æ ¼,åŠ æ–™åƒ¹æ ¼,ç¸½å–®åƒ¹,æ•¸é‡,å°è¨ˆ\n';
            
            for (let i = 0; i < rows.length - 1; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td');
                
                if (cells.length >= 10) {
                    const time = cells[0].textContent.trim();
                    const customerName = cells[1].textContent.trim();
                    const category = cells[2].textContent.trim();
                    const item = cells[3].textContent.trim();
                    const sweetness = cells[4].textContent.trim();
                    const ice = cells[5].textContent.trim();
                    const toppings = cells[6].textContent.trim();
                    const priceText = cells[7].textContent.trim();
                    const quantity = cells[8].textContent.trim();
                    const subtotal = cells[9].textContent.replace('NT$ ', '').trim();
                    
                    let basePrice = '';
                    let toppingPrice = '0';
                    let totalPrice = '';
                    
                    if (priceText.includes(' + ')) {
                        const prices = priceText.split(' + ');
                        basePrice = prices[0].replace('NT$ ', '');
                        toppingPrice = prices[1];
                        totalPrice = (parseInt(basePrice) + parseInt(toppingPrice)).toString();
                    } else {
                        basePrice = priceText.replace('NT$ ', '');
                        totalPrice = basePrice;
                    }
                    
                    csv += `"${time}","${customerName}","${category}","${item}","${sweetness}","${ice}","${toppings}",${basePrice},${toppingPrice},${totalPrice},${quantity},${subtotal}\n`;
                }
            }

            const totalRow = rows[rows.length - 1];
            if (totalRow && totalRow.classList.contains('total-row')) {
                const totalCells = totalRow.querySelectorAll('td');
                if (totalCells.length >= 3) {
                    const totalQuantity = totalCells[totalCells.length - 2].textContent.trim();
                    const totalAmount = totalCells[totalCells.length - 1].textContent.replace('NT$ ', '').trim();
                    csv += `ç¸½è¨ˆ,,,,,,,,,,${totalQuantity},${totalAmount}\n`;
                }
            }

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `èŒ¶é£²è¨‚å–®_${new Date().toISOString().slice(0, 10)}.csv`);
            link.click();
        }

        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            categorySelect.addEventListener('change', function() {
                const category = this.value;
                itemSelect.innerHTML = '<option value="">è«‹é¸æ“‡å“é …</option>';
                
                if (category && menuData[category]) {
                    Object.keys(menuData[category]).forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;
                        option.textContent = `${item} - NT$ ${menuData[category][item]}`;
                        option.dataset.price = menuData[category][item];
                        itemSelect.appendChild(option);
                    });
                    itemSelect.disabled = false;
                    customerNameInput.disabled = false;
                } else {
                    itemSelect.disabled = true;
                    customerNameInput.disabled = true;
                    optionsGroup.style.display = 'none';
                    quantityInput.disabled = true;
                    addBtn.disabled = true;
                }
            });

            itemSelect.addEventListener('change', function() {
                if (this.value) {
                    optionsGroup.style.display = 'block';
                    quantityInput.disabled = false;
                    addBtn.disabled = false;
                } else {
                    optionsGroup.style.display = 'none';
                    quantityInput.disabled = true;
                    addBtn.disabled = true;
                }
            });

            addBtn.addEventListener('click', addOrder);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('clearBtn').addEventListener('click', clearAllOrders);
        }

        // äº‹ä»¶ç›£è½å™¨è¨­å®š
        loginBtn.addEventListener('click', checkPassword);
        logoutBtn.addEventListener('click', logout);
        
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        window.addEventListener('load', function() {
            const isAuthenticated = localStorage.getItem('teaOrderAuth') === 'true';
            if (isAuthenticated) {
                showMainPage();
            } else {
                passwordInput.focus();
            }
        });

        // é é¢é—œé–‰æ™‚æ¸…ç†ç›£è½å™¨
        window.addEventListener('beforeunload', function() {
            if (unsubscribe) {
                unsubscribe();
            }
        });

        // å…¨åŸŸå‡½æ•¸
        window.removeOrder = removeOrder;
    </script>
</body>
</html>